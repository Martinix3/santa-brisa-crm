(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4600],{14636:(e,a,l)=>{"use strict";l.d(a,{AM:()=>r,Wv:()=>d,hl:()=>o});var t=l(95155),s=l(12115),n=l(20547),i=l(59434);let r=n.bL,d=n.l9,o=s.forwardRef((e,a)=>{let{className:l,align:s="center",sideOffset:r=4,...d}=e;return(0,t.jsx)(n.ZL,{children:(0,t.jsx)(n.UC,{ref:a,align:s,sideOffset:r,className:(0,i.cn)("z-50 w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",l),...d})})});o.displayName=n.UC.displayName},17607:(e,a,l)=>{"use strict";l.d(a,{A:()=>t});let t=(0,l(40157).A)("Eye",[["path",{d:"M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0",key:"1nclc0"}],["circle",{cx:"12",cy:"12",r:"3",key:"1v7zrd"}]])},19564:(e,a,l)=>{"use strict";l.d(a,{y:()=>s});var t=l(34477);let s=(0,t.createServerReference)("7f1e87e0573a6b4c8c91b413e52b517bc8f151c7f9",t.callServer,void 0,t.findSourceMapURL,"getInventoryItemsFS")},40413:(e,a,l)=>{"use strict";l.d(a,{P:()=>s});var t=l(34477);let s=(0,t.createServerReference)("7fce113003000975f3cda9fc515d7d6e3dd62e5158",t.callServer,void 0,t.findSourceMapURL,"deleteOrderFS")},43295:(e,a,l)=>{Promise.resolve().then(l.bind(l,54203))},47262:(e,a,l)=>{"use strict";l.d(a,{S:()=>d});var t=l(95155),s=l(12115),n=l(76981),i=l(10518),r=l(59434);let d=s.forwardRef((e,a)=>{let{className:l,...s}=e;return(0,t.jsx)(n.bL,{ref:a,className:(0,r.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",l),...s,children:(0,t.jsx)(n.C1,{className:(0,r.cn)("flex items-center justify-center text-current"),children:(0,t.jsx)(i.A,{className:"h-4 w-4"})})})});d.displayName=n.bL.displayName},54203:(e,a,l)=>{"use strict";l.r(a),l.d(a,{default:()=>ep});var t=l(95155),s=l(12115),n=l(66695),i=l(85127),r=l(30285),d=l(44838),o=l(62523),c=l(47262),u=l(93473),m=l(94815),h=l(9572),x=l(79556),p=l(98328),j=l(40157);let v=(0,j.A)("Download",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"7 10 12 15 17 10",key:"2ggqvy"}],["line",{x1:"12",x2:"12",y1:"15",y2:"3",key:"1vk2je"}]]);var g=l(50172),f=l(83662),y=l(91721),N=l(3561),b=l(17607),C=l(18763),w=l(77223),A=l(24371),S=l(14636),R=l(85511),M=l(83343),P=l(44861),I=l(70831),E=l(73168),F=l(61055),k=l(59434),U=l(90221),D=l(62177),L=l(68663),O=l(54165),z=l(17759),T=l(88539),V=l(59409);let _=(0,j.A)("CreditCard",[["rect",{width:"20",height:"14",x:"2",y:"5",rx:"2",key:"ynyp8z"}],["line",{x1:"2",x2:"22",y1:"10",y2:"10",key:"1b3vmo"}]]);var B=l(91467);let q=(0,j.A)("Zap",[["path",{d:"M4 14a1 1 0 0 1-.78-1.63l9.9-10.2a.5.5 0 0 1 .86.46l-1.92 6.02A1 1 0 0 0 13 10h7a1 1 0 0 1 .78 1.63l-9.9 10.2a.5.5 0 0 1-.86-.46l1.92-6.02A1 1 0 0 0 11 14z",key:"1xq2db"}]]),J=(0,j.A)("Link2",[["path",{d:"M9 17H7A5 5 0 0 1 7 7h2",key:"8i5ue5"}],["path",{d:"M15 7h2a5 5 0 1 1 0 10h-2",key:"1b9ql8"}],["line",{x1:"8",x2:"16",y1:"12",y2:"12",key:"1jonct"}]]);var H=l(51920),$=l(34301),G=l(18018),Y=l(22346),Z=l(61930),Q=l(16021),X=l(19564),W=l(87481),K=l(6874),ee=l.n(K);let ea="##NONE##",el=L.Ik({clientName:L.Yj().optional(),products:L.Yj().optional(),value:L.au.number({invalid_type_error:"Debe ser un n\xfamero"}).positive("El valor debe ser positivo.").optional().nullable(),status:L.k5(u.X$),salesRep:L.Yj().optional(),clavadistaId:L.Yj().optional().nullable(),canalOrigenColocacion:L.k5(u.QZ).optional(),paymentMethod:L.k5(u.IJ).optional(),invoiceUrl:L.Yj().trim().url("Debe ser una URL v\xe1lida.").or(L.eu("")).optional().nullable(),invoiceFileName:L.Yj().optional(),assignedMaterials:L.YO(L.Ik({materialId:L.Yj().min(1,"Debe seleccionar un material."),quantity:L.au.number().min(1,"La cantidad debe ser al menos 1.")})).optional().default([]),clientType:L.k5(u.QM).optional(),numberOfUnits:L.au.number({invalid_type_error:"Debe ser un n\xfamero."}).positive("El n\xfamero de unidades debe ser positivo.").optional().nullable(),unitPrice:L.au.number({invalid_type_error:"Debe ser un n\xfamero."}).positive("El precio unitario debe ser positivo.").optional().nullable(),notes:L.Yj().optional(),nextActionType:L.k5(u.Cv).optional(),nextActionCustom:L.Yj().optional(),nextActionDate:L.p6().optional(),failureReasonType:L.k5(u.HF).optional(),failureReasonCustom:L.Yj().optional()});function et(e){let{order:a,isOpen:l,onOpenChange:n,onSave:i,currentUserRole:d,allAccounts:c=[]}=e,[m,h]=s.useState(!1),[x,p]=s.useState([]),[j,v]=s.useState([]),[f,y]=s.useState([]),[N,b]=s.useState(!0),{toast:C}=(0,W.dj)(),A=s.useMemo(()=>a?a.accountId?c.find(e=>e.id===a.accountId)||null:c.find(e=>e.nombre.toLowerCase().trim()===a.clientName.toLowerCase().trim())||null:null,[a,c]),I=e=>{if(!e)return"No especificada";let a=[e.street?"".concat(e.street).concat(e.number?", ".concat(e.number):""):null,e.city,e.province,e.postalCode].filter(Boolean);return 0===a.length?"No especificada":a.join(",\n")},L=(0,D.mN)({resolver:(0,U.u)(el),mode:"onChange",defaultValues:{clientName:"",products:"",value:void 0,status:"Pendiente",salesRep:"",clavadistaId:ea,canalOrigenColocacion:void 0,paymentMethod:void 0,invoiceUrl:"",invoiceFileName:"",assignedMaterials:[],clientType:void 0,numberOfUnits:void 0,unitPrice:void 0,notes:"",nextActionType:void 0,nextActionCustom:"",nextActionDate:void 0,failureReasonType:void 0,failureReasonCustom:""}}),{fields:K,append:et,remove:es}=(0,D.jz)({control:L.control,name:"assignedMaterials"}),en=L.watch("invoiceUrl"),ei=L.watch("assignedMaterials"),er=s.useMemo(()=>ei.reduce((e,a)=>{var l;let t=f.find(e=>e.id===a.materialId),s=(null==t||null==(l=t.latestPurchase)?void 0:l.calculatedUnitCost)||0;return e+a.quantity*s},0),[ei,f]),ed=L.watch("status"),eo="Admin"===d,ec="Distributor"===d;s.useEffect(()=>{l&&(b(!0),Promise.all([(0,Q.I)(["Clavadista"]),(0,Q.I)(["SalesRep","Admin"]),(0,X.y)()]).then(e=>{let[a,l,t]=e;p(a),v(l),y(t.filter(e=>e.latestPurchase&&e.latestPurchase.calculatedUnitCost>0))}).catch(e=>{console.error("Error loading data for edit order dialog:",e),C({title:"Error Datos Di\xe1logo",description:"No se pudieron cargar datos para el di\xe1logo.",variant:"destructive"})}).finally(()=>{b(!1)}))},[l,C]),s.useEffect(()=>{if(l&&a){var e,t,s,n,i,r;L.reset({clientName:a.clientName||"",products:Array.isArray(a.products)?a.products.join(", "):"",value:null!=(e=a.value)?e:void 0,status:a.status,salesRep:a.salesRep||"",clavadistaId:a.clavadistaId||ea,canalOrigenColocacion:a.canalOrigenColocacion||void 0,paymentMethod:a.paymentMethod||void 0,invoiceUrl:a.invoiceUrl||"",invoiceFileName:a.invoiceFileName||"",assignedMaterials:a.assignedMaterials||[],clientType:null!=(t=a.clientType)?t:void 0,numberOfUnits:null!=(s=a.numberOfUnits)?s:void 0,unitPrice:null!=(n=a.unitPrice)?n:void 0,notes:a.notes||"",nextActionType:null!=(i=a.nextActionType)?i:void 0,nextActionCustom:a.nextActionCustom||"",nextActionDate:a.nextActionDate&&(0,P.f)((0,M.H)(a.nextActionDate))?(0,M.H)(a.nextActionDate):void 0,failureReasonType:null!=(r=a.failureReasonType)?r:void 0,failureReasonCustom:a.failureReasonCustom||""}),L.trigger()}},[a,l,L]),s.useEffect(()=>{let e=["Seguimiento","Fallido","Programada"].includes(ed),a="Facturado"!==ed;e&&(void 0!==L.getValues("clientType")&&L.setValue("clientType",void 0,{shouldDirty:!0}),void 0!==L.getValues("products")&&""!==L.getValues("products")&&L.setValue("products","",{shouldDirty:!0}),void 0!==L.getValues("numberOfUnits")&&L.setValue("numberOfUnits",void 0,{shouldDirty:!0}),void 0!==L.getValues("unitPrice")&&L.setValue("unitPrice",void 0,{shouldDirty:!0}),void 0!==L.getValues("paymentMethod")&&L.setValue("paymentMethod",void 0,{shouldDirty:!0})),a&&null!==L.getValues("invoiceUrl")&&void 0!==L.getValues("invoiceUrl")&&""!==L.getValues("invoiceUrl")&&L.setValue("invoiceUrl",null,{shouldDirty:!0}),L.trigger()},[ed,L]);let eu=async e=>{if(!a)return;let l={...e};l.clavadistaId===ea&&delete l.clavadistaId,h(!0);try{await i(l,a.id)}catch(e){console.error("Fallo al guardar desde el di\xe1logo:",e),C({title:"Error al Guardar",description:"No se pudo guardar: ".concat(e.message),variant:"destructive"})}finally{h(!1)}},em=ec&&!eo,eh="SalesRep"===d||!eo&&!ec,ex=eh||N,ep=!eo||["Seguimiento","Fallido","Programada"].includes(ed)||N,ej=!(eo||em)||N,ev=!(eo||em)||N,eg=!eo||N,ef=!eo||N,ey=!eo||N,eN=!eo||ep,eb=!eo||"Programada"===ed||N,eC=!(eo||ec)||N;return!a&&l?(0,t.jsx)(O.lG,{open:l,onOpenChange:n,children:(0,t.jsxs)(O.Cf,{children:[(0,t.jsx)(O.c7,{children:(0,t.jsx)(O.L3,{children:"Error"})}),(0,t.jsx)("p",{children:"No se ha proporcionado informaci\xf3n del pedido."}),(0,t.jsx)(O.Es,{children:(0,t.jsx)(O.HM,{asChild:!0,children:(0,t.jsx)(r.$,{children:"Cerrar"})})})]})}):(0,t.jsx)(O.lG,{open:l,onOpenChange:n,children:(0,t.jsxs)(O.Cf,{className:"sm:max-w-md md:max-w-lg lg:max-w-3xl xl:max-w-4xl max-h-[90vh] overflow-y-auto print-dialog-content",children:[(0,t.jsxs)(O.c7,{className:"print-hide",children:[(0,t.jsxs)(O.L3,{children:[eh&&!em?"Detalles Pedido:":"Editar Pedido:"," ",null==a?void 0:a.id," (",null==a?void 0:a.status,")"]}),(0,t.jsx)(O.rr,{children:eh&&!em?"Viendo los detalles del pedido.":"Modifique los detalles del pedido y/o el estado. Haga clic en guardar cuando haya terminado."})]}),N?(0,t.jsxs)("div",{className:"flex justify-center items-center h-[300px]",children:[(0,t.jsx)(g.A,{className:"h-8 w-8 animate-spin text-primary"}),(0,t.jsx)("p",{className:"ml-2 text-muted-foreground",children:"Cargando detalles..."})]}):(0,t.jsx)(z.lV,{...L,children:(0,t.jsxs)("form",{onSubmit:L.handleSubmit(eu),children:[(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,t.jsx)(z.zB,{control:L.control,name:"clientName",render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Nombre del Cliente"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{placeholder:"Nombre del cliente",...l,value:null!=(a=l.value)?a:"",disabled:!eo||ex})}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"salesRep",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Representante de Ventas"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:eg,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccione un representante"})})}),(0,t.jsx)(V.gC,{children:j.map(e=>(0,t.jsxs)(V.eb,{value:e.name,children:[e.name," (","SalesRep"===e.role?"Rep. Ventas":e.role,")"]},e.id))})]}),(0,t.jsx)(z.C5,{})]})}})]}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:[(0,t.jsx)(z.zB,{control:L.control,name:"status",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Estado"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:ej,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccione un estado"})})}),(0,t.jsx)(V.gC,{children:u.X$.filter(e=>"Programada"!==e&&"Fallido"!==e&&"Seguimiento"!==e).map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"paymentMethod",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsxs)(z.lR,{className:"flex items-center",children:[(0,t.jsx)(_,{className:"mr-1 h-4 w-4"}),"Forma Pago"]}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:eN,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccionar forma de pago"})})}),(0,t.jsx)(V.gC,{children:u.IJ.map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"clavadistaId",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsxs)(z.lR,{className:"flex items-center",children:[(0,t.jsx)(B.A,{className:"mr-2 h-4 w-4 text-primary"}),"Clavadista"]}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value||ea,disabled:ef,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccionar clavadista"})})}),(0,t.jsxs)(V.gC,{children:[(0,t.jsx)(V.eb,{value:ea,children:"Ninguno"}),x.map(e=>(0,t.jsx)(V.eb,{value:e.id,children:e.name},e.id))]})]}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"canalOrigenColocacion",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsxs)(z.lR,{className:"flex items-center",children:[(0,t.jsx)(q,{className:"mr-2 h-4 w-4 text-primary"}),"Canal Origen"]}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:ey,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccionar canal"})})}),(0,t.jsx)(V.gC,{children:u.QZ.map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]}),(0,t.jsx)(z.C5,{})]})}})]}),A&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground",children:"Detalles de la Cuenta"}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6 text-sm p-3 border rounded-md bg-muted/50",children:[(0,t.jsxs)("div",{className:"md:col-span-1 space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"Nombre Fiscal"}),(0,t.jsx)("p",{children:A.legalName||"No especificado"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"CIF/NIF"}),(0,t.jsx)("p",{children:A.cif||"No especificado"})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"Tipo de Cuenta"}),(0,t.jsx)("p",{children:A.type})]})]}),(0,t.jsxs)("div",{className:"md:col-span-1 space-y-4",children:[(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"Direcci\xf3n Facturaci\xf3n"}),(0,t.jsx)("p",{className:"whitespace-pre-line",children:I(A.addressBilling)})]}),(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"Direcci\xf3n Entrega"}),(0,t.jsx)("p",{className:"whitespace-pre-line",children:I(A.addressShipping)})]})]}),(0,t.jsx)("div",{className:"md:col-span-1 space-y-4",children:(0,t.jsxs)("div",{children:[(0,t.jsx)("p",{className:"font-semibold",children:"Contacto Principal"}),(0,t.jsxs)("div",{className:"space-y-1",children:[(0,t.jsx)("p",{className:"font-medium",children:A.mainContactName||"No disponible"}),A.mainContactEmail&&(0,t.jsx)("a",{href:"mailto:".concat(A.mainContactEmail),className:"text-primary hover:underline block truncate",children:A.mainContactEmail}),A.mainContactPhone&&(0,t.jsx)("a",{href:"tel:".concat(A.mainContactPhone),className:"text-primary hover:underline block",children:A.mainContactPhone}),!(A.mainContactEmail||A.mainContactPhone)&&!A.mainContactName&&(0,t.jsx)("p",{className:"text-muted-foreground italic",children:"Sin datos"})]})]})})]})]}),(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground pt-2",children:"Informaci\xf3n del Pedido y Productos"}),["Seguimiento","Fallido","Programada"].includes(ed)?(0,t.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Los detalles de productos y valor no aplican para el estado actual del pedido (",ed,")."]}):(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(z.zB,{control:L.control,name:"clientType",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Tipo de Cliente"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:ep,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"Seleccione tipo cliente"})})}),(0,t.jsx)(V.gC,{children:u.QM.map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"products",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Productos Pedidos"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(T.T,{placeholder:"Listar productos y cantidades...",className:"min-h-[80px]",...a,disabled:ep})}),(0,t.jsx)(z.Rr,{children:"Separe m\xfaltiples productos con comas, punto y coma o saltos de l\xednea."}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,t.jsx)(z.zB,{control:L.control,name:"numberOfUnits",render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"N\xba Unidades Totales"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{type:"number",...l,onChange:e=>l.onChange(""===e.target.value?void 0:parseInt(e.target.value,10)),value:null!=(a=l.value)?a:"",disabled:ep})}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"unitPrice",render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Precio Unitario Medio (€ sin IVA)"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{type:"number",step:"0.01",...l,onChange:e=>l.onChange(""===e.target.value?void 0:parseFloat(e.target.value)),value:null!=(a=l.value)?a:"",disabled:ep})}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"value",render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Valor Total Pedido (€ IVA incl.)"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{type:"number",step:"0.01",...l,onChange:e=>l.onChange(""===e.target.value?void 0:parseFloat(e.target.value)),value:null!=(a=l.value)?a:"",disabled:ep})}),(0,t.jsx)(z.C5,{})]})}})]})]}),"Facturado"===ed&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground",children:"Informaci\xf3n de Factura"}),(0,t.jsx)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 items-end",children:(0,t.jsx)(z.zB,{control:L.control,name:"invoiceUrl",render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"URL de la Factura"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{placeholder:"https://ejemplo.com/factura.pdf",...l,value:null!=(a=l.value)?a:"",disabled:eC})}),(0,t.jsx)(z.C5,{})]})}})}),en&&function(e){if(!e)return!1;try{return new URL(e),!0}catch(e){return!1}}(en)&&(0,t.jsx)(r.$,{variant:"link",asChild:!0,className:"p-0 h-auto mt-1",children:(0,t.jsxs)(ee(),{href:en,target:"_blank",rel:"noopener noreferrer",className:"text-sm",children:[(0,t.jsx)(J,{className:"mr-1 h-3 w-3"})," Ver Factura Cargada"]})})]}),((null==a?void 0:a.status)==="Seguimiento"||(null==a?void 0:a.status)==="Fallido"||(null==a?void 0:a.status)==="Programada")&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground",children:"Informaci\xf3n de Seguimiento/Programaci\xf3n Original"}),(0,t.jsx)(z.zB,{control:L.control,name:"nextActionType",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Pr\xf3xima Acci\xf3n (Original)"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:!0,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"N/A"})})}),(0,t.jsx)(V.gC,{children:u.Cv.map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]})]})}}),(null==a?void 0:a.nextActionType)==="Opci\xf3n personalizada"&&(0,t.jsx)(z.zB,{control:L.control,name:"nextActionCustom",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Detalle Pr\xf3x. Acci\xf3n Personalizada (Original)"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{...a,disabled:!0})})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"nextActionDate",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{className:"flex flex-col",children:[(0,t.jsx)(z.lR,{children:"Fecha Pr\xf3x. Acci\xf3n (Original)"}),(0,t.jsxs)(S.AM,{children:[(0,t.jsx)(S.Wv,{asChild:!0,children:(0,t.jsx)(z.MJ,{children:(0,t.jsxs)(r.$,{variant:"outline",className:(0,k.cn)("w-full pl-3 text-left font-normal",!a.value&&"text-muted-foreground"),disabled:!0,children:[a.value?(0,E.GP)(a.value,"PPP",{locale:F.es}):(0,t.jsx)("span",{children:"N/A"}),(0,t.jsx)(H.A,{className:"ml-auto h-4 w-4 opacity-50"})]})})}),(0,t.jsx)(S.hl,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(R.V,{mode:"single",selected:a.value,onSelect:a.onChange,initialFocus:!0,locale:F.es})})]})]})}}),(null==a?void 0:a.status)==="Fallido"&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(z.zB,{control:L.control,name:"failureReasonType",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Motivo Fallo (Original)"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:!0,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:"N/A"})})}),(0,t.jsx)(V.gC,{children:u.HF.map(e=>(0,t.jsx)(V.eb,{value:e,children:e},e))})]})]})}}),(null==a?void 0:a.failureReasonType)==="Otro (especificar)"&&(0,t.jsx)(z.zB,{control:L.control,name:"failureReasonCustom",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Detalle Motivo Fallo Personalizado (Original)"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(T.T,{...a,disabled:!0})})]})}})]})]}),"Programada"!==ed&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground",children:"Materiales Promocionales Asignados"}),(0,t.jsxs)("div",{className:"space-y-3",children:[N&&(0,t.jsx)(g.A,{className:"h-4 w-4 animate-spin"}),!N&&K.map((e,a)=>{var l,s;let n=f.find(e=>{var l;return e.id===(null==(l=ei[a])?void 0:l.materialId)}),i=(null==n||null==(l=n.latestPurchase)?void 0:l.calculatedUnitCost)||0;return(0,t.jsxs)("div",{className:"flex items-end gap-2 p-3 border rounded-md bg-secondary/30",children:[(0,t.jsx)(z.zB,{control:L.control,name:"assignedMaterials.".concat(a,".materialId"),render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{className:"flex-grow",children:[(0,t.jsx)(z.lR,{className:"text-xs",children:"Material"}),(0,t.jsxs)(V.l6,{onValueChange:a.onChange,value:a.value,disabled:eb,children:[(0,t.jsx)(z.MJ,{children:(0,t.jsx)(V.bq,{children:(0,t.jsx)(V.yv,{placeholder:N?"Cargando...":"Seleccionar material"})})}),(0,t.jsx)(V.gC,{children:f.map(e=>{var a;return(0,t.jsxs)(V.eb,{value:e.id,children:[e.name," - ",(0,t.jsx)(Z.A,{value:(null==(a=e.latestPurchase)?void 0:a.calculatedUnitCost)||0,options:{style:"currency",currency:"EUR",minimumFractionDigits:2,maximumFractionDigits:4}})]},e.id)})})]}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)(z.zB,{control:L.control,name:"assignedMaterials.".concat(a,".quantity"),render:e=>{var a;let{field:l}=e;return(0,t.jsxs)(z.eI,{className:"w-24",children:[(0,t.jsx)(z.lR,{className:"text-xs",children:"Cantidad"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(o.p,{type:"number",...l,disabled:eb,onChange:e=>l.onChange(""===e.target.value?void 0:Number(e.target.value.replace(",","."))),value:null!=(a=l.value)?a:""})}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsx)("div",{className:"text-sm text-muted-foreground w-28 text-right whitespace-nowrap",children:(null==(s=ei[a])?void 0:s.quantity)>0?(0,t.jsx)(Z.A,{value:i*ei[a].quantity,options:{style:"currency",currency:"EUR"}}):(0,t.jsx)(Z.A,{value:0,options:{style:"currency",currency:"EUR"}})}),!eb&&(0,t.jsx)(r.$,{type:"button",variant:"ghost",size:"icon",onClick:()=>es(a),className:"text-destructive hover:bg-destructive/10",children:(0,t.jsx)(w.A,{className:"h-4 w-4"})})]},e.id)}),!eb&&(0,t.jsxs)(r.$,{type:"button",variant:"outline",size:"sm",onClick:()=>et({materialId:"",quantity:1}),className:"mt-2",disabled:N,children:[(0,t.jsx)($.A,{className:"mr-2 h-4 w-4"})," A\xf1adir Material"]}),ei.length>0&&(0,t.jsxs)("div",{className:"text-right font-medium text-primary pt-2",children:["Coste Total Estimado Materiales: ",(0,t.jsx)(Z.A,{value:er,options:{style:"currency",currency:"EUR"}})]})]})]}),(0,t.jsx)(Y.w,{className:"my-6"}),(0,t.jsx)("h3",{className:"text-md font-semibold text-muted-foreground",children:"Notas Adicionales"}),(0,t.jsx)(z.zB,{control:L.control,name:"notes",render:e=>{let{field:a}=e;return(0,t.jsxs)(z.eI,{children:[(0,t.jsx)(z.lR,{children:"Notas Generales del Pedido/Visita"}),(0,t.jsx)(z.MJ,{children:(0,t.jsx)(T.T,{placeholder:"Notas sobre el pedido o visita...",...a,className:"min-h-[60px]",disabled:ev})}),(0,t.jsx)(z.C5,{})]})}}),(0,t.jsxs)(O.Es,{className:"pt-6 print-hide",children:[(0,t.jsxs)(r.$,{type:"button",variant:"outline",onClick:()=>{window.print()},className:"mr-auto",children:[(0,t.jsx)(G.A,{className:"mr-2 h-4 w-4"})," Imprimir Ficha"]}),(0,t.jsx)(O.HM,{asChild:!0,children:(0,t.jsx)(r.$,{type:"button",variant:"outline",disabled:m,children:"Cancelar"})}),!(eh&&!em)&&(0,t.jsx)(r.$,{type:"submit",disabled:m||N||!L.formState.isDirty&&!!a,children:m?(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(g.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardando..."]}):"Guardar Cambios"})]})]})})]})})}var es=l(51055),en=l(90010),ei=l(96656),er=l(79557),ed=l(34477);let eo=(0,ed.createServerReference)("7ff37576cd1c772f75f6dc2a67eb95501d756eeda7",ed.callServer,void 0,ed.findSourceMapURL,"updateFullOrderFS");var ec=l(56822),eu=l(40413),em=l(65331),eh=l(49157),ex=l(99058);function ep(){let{toast:e}=(0,W.dj)(),{userRole:a,dataSignature:l,refreshDataSignature:j}=(0,es.A)(),[U,D]=s.useState([]),[L,O]=s.useState(!0),[z,T]=s.useState([]),[V,_]=s.useState([]),[B,q]=s.useState(""),[J,H]=s.useState("Todos"),[$,G]=s.useState(void 0),[Y,X]=s.useState(""),[K,ea]=s.useState([]),[el,ed]=s.useState(null),[ep,ej]=s.useState(!1),[ev,eg]=s.useState(null),[ef,ey]=s.useState(null);s.useEffect(()=>{!async function(){O(!0);try{let[e,l]=await Promise.all([(0,er.r)(),(0,em.U)()]),t=["Programada","Seguimiento","Fallido","Completado"];if(D(e.filter(e=>!t.includes(e.status))),_(l),"Admin"===a){let e=await (0,Q.I)(["SalesRep","Admin"]);T(e)}}catch(a){console.error("Error fetching orders or team members:",a),e({title:"Error al Cargar Datos",description:"No se pudieron cargar los pedidos o miembros del equipo.",variant:"destructive"})}finally{O(!1)}}()},[e,l,a]);let eN=["Todos",...u.X$.filter(e=>!["Programada","Seguimiento","Fallido","Completado"].includes(e))],eb=s.useMemo(()=>new Map(V.map(e=>[e.id,e])),[V]),eC=s.useMemo(()=>{let e=new Map;return V.forEach(a=>{a.nombre&&!e.has(a.nombre.toLowerCase().trim())&&e.set(a.nombre.toLowerCase().trim(),a)}),e},[V]),ew=s.useMemo(()=>U.filter(e=>e.clientName.toLowerCase().includes(B.toLowerCase())||e.salesRep&&e.salesRep.toLowerCase().includes(B.toLowerCase())).filter(e=>"Todos"===J||e.status===J).filter(e=>{if(!(null==$?void 0:$.from))return!0;let a=(0,M.H)(e.visitDate);if(!(0,P.f)(a))return!1;let l=$.from,t=$.to?(0,I.f)($.to,1):new Date(864e13);return a>=l&&a<t}).filter(e=>{var a,l,t,s;if(!Y)return!0;let n=e.accountId?eb.get(e.accountId):eC.get(e.clientName.toLowerCase().trim());if(!n)return!1;let i=Y.toLowerCase(),r=n.addressShipping,d=n.addressBilling,o=null==r||null==(a=r.province)?void 0:a.toLowerCase(),c=null==r||null==(l=r.city)?void 0:l.toLowerCase(),u=null==d||null==(t=d.province)?void 0:t.toLowerCase(),m=null==d||null==(s=d.city)?void 0:s.toLowerCase();return o&&o.includes(i)||c&&c.includes(i)||u&&u.includes(i)||m&&m.includes(i)}),[U,eb,eC,B,J,$,Y]),eA=e=>{ed(e),ej(!0)},eS=async(l,t)=>{O(!0);try{let s=U.find(e=>e.id===t);if(!s){e({title:"Error",description:"Pedido no encontrado.",variant:"destructive"}),O(!1);return}let n="Admin"===a,i="Distributor"===a,r=n||i,d={clientName:n&&l.clientName?l.clientName:s.clientName,products:n&&l.products?l.products.split(/[,;\n]+/).map(e=>e.trim()).filter(e=>e.length>0):s.products,value:n&&void 0!==l.value?l.value:s.value,salesRep:n&&l.salesRep?l.salesRep:s.salesRep,clavadistaId:n?"##NONE##"===l.clavadistaId?null:l.clavadistaId:s.clavadistaId,paymentMethod:n?l.paymentMethod:s.paymentMethod,invoiceUrl:n?l.invoiceUrl:s.invoiceUrl,invoiceFileName:n?l.invoiceFileName:s.invoiceFileName,assignedMaterials:n?l.assignedMaterials:s.assignedMaterials,clientType:n?l.clientType:s.clientType,numberOfUnits:n&&void 0!==l.numberOfUnits?l.numberOfUnits:s.numberOfUnits,unitPrice:n&&void 0!==l.unitPrice?l.unitPrice:s.unitPrice,status:r?l.status:s.status,notes:r?l.notes:s.notes,lastUpdated:(0,E.GP)(new Date,"yyyy-MM-dd"),accountId:s.accountId,visitDate:s.visitDate,createdAt:s.createdAt,clientStatus:s.clientStatus,nextActionType:s.nextActionType,nextActionCustom:s.nextActionCustom,nextActionDate:s.nextActionDate,failureReasonType:s.failureReasonType,failureReasonCustom:s.failureReasonCustom,canalOrigenColocacion:n?l.canalOrigenColocacion:s.canalOrigenColocacion};if(await eo(t,d),D(e=>e.map(e=>e.id===t?{...e,...d}:e)),e({title:"\xa1Pedido Actualizado!",description:"Pedido ".concat(t," actualizado exitosamente."),variant:"default"}),n&&s.accountId&&d.salesRep&&d.salesRep!==s.salesRep){let a=d.salesRep,l=z.find(e=>e.name===a);if(l&&"SalesRep"===l.role){let a=await (0,eh.p)(s.accountId);if(a&&a.salesRepId!==l.id)try{await (0,ex.k)(s.accountId,{salesRepId:l.id}),e({title:"Cuenta Actualizada",description:"Comercial de la cuenta ".concat(a.name," actualizado a ").concat(l.name,"."),variant:"default"})}catch(a){console.error("Error updating account's salesRepId:",a),e({title:"Error al Actualizar Cuenta",description:"No se pudo actualizar el comercial de la cuenta asociada.",variant:"destructive"})}}else l&&"SalesRep"!==l.role&&console.log("El nuevo comercial ".concat(l.name," no es SalesRep. No se actualiza el comercial de la cuenta ").concat(s.accountId,"."))}j()}catch(a){console.error("Error updating order:",a),e({title:"Error al Actualizar",description:"No se pudo actualizar el pedido en Firestore.",variant:"destructive"})}finally{O(!1),ep&&ej(!1),ed(null)}},eR=e=>{eT&&eg(e)},eM=e=>{"Admin"===a&&ey(e)},eP=async()=>{if(eT&&ev){O(!0);try{await (0,ec.t)(ev.id,"Cancelado"),e({title:"\xa1Pedido Cancelado!",description:'El pedido "'.concat(ev.id,'" ha sido cancelado.'),variant:"default"}),j()}catch(a){console.error("Error canceling order:",a),e({title:"Error al Cancelar",description:"No se pudo cancelar el pedido.",variant:"destructive"})}finally{O(!1),eg(null)}}},eI=async()=>{if("Admin"===a&&ef){O(!0);try{await (0,eu.P)(ef.id),e({title:"\xa1Pedido Eliminado!",description:'El pedido de "'.concat(ef.clientName,'" ha sido eliminado permanentemente.'),variant:"destructive"}),j()}catch(a){console.error("Error deleting order:",a),e({title:"Error al Eliminar",description:"No se pudo eliminar el pedido.",variant:"destructive"})}finally{O(!1),ey(null)}}},eE=async(a,l)=>{if(!ez)return void e({title:"Permiso Denegado",description:"No tienes permiso para cambiar el estado del pedido.",variant:"destructive"});O(!0);try{let t={status:l,lastUpdated:(0,E.GP)(new Date,"yyyy-MM-dd")};await (0,ec.t)(a.id,l),D(e=>e.map(e=>e.id===a.id?{...e,...t}:e)),e({title:"Estado Actualizado",description:"El estado del pedido ".concat(a.id," es ahora ").concat(l,".")}),j()}catch(a){console.error("Error updating order status:",a),e({title:"Error al Cambiar Estado",description:"No se pudo actualizar el estado del pedido.",variant:"destructive"})}finally{O(!1)}},eF=e=>{!0===e?ea(ew.map(e=>e.id)):ea([])},ek=(e,a)=>{a?ea(a=>[...a,e]):ea(a=>a.filter(a=>a!==e))},eU=s.useMemo(()=>{if(0===ew.length)return!1;let e=K.length===ew.length&&ew.every(e=>K.includes(e.id));return!!e||!!(K.length>0&&!e&&ew.some(e=>K.includes(e.id)))&&"indeterminate"},[K,ew]),eD=e=>{if(null==e)return"";let a=String(e);return a.includes(",")||a.includes("\n")||a.includes('"')?'"'.concat(a.replace(/"/g,'""'),'"'):a},eL=e=>e?"".concat(e.street||"").concat(e.number?", ".concat(e.number):"",", ").concat(e.city||"",", ").concat(e.province||"",", ").concat(e.postalCode||"").concat(e.country?", ".concat(e.country):""):"",eO="Admin"===a,ez="Admin"===a||"Distributor"===a,eT="Admin"===a,eV="Admin"===a||"Distributor"===a;return(0,t.jsxs)("div",{className:"space-y-6",children:[(0,t.jsxs)("header",{className:"flex items-center space-x-2",children:[(0,t.jsx)(m.A,{className:"h-8 w-8 text-primary"}),(0,t.jsx)("h1",{className:"text-3xl font-headline font-semibold",children:"Gesti\xf3n Integral de Pedidos"})]}),(0,t.jsxs)(n.Zp,{className:"shadow-subtle hover:shadow-md transition-shadow duration-300",children:[(0,t.jsxs)(n.aR,{children:[(0,t.jsx)(n.ZB,{children:"Gestionar Pedidos"}),(0,t.jsx)(n.BT,{children:"Visualiza, filtra y administra todos los pedidos de clientes. Los administradores y distribuidores pueden cambiar estados y descargar informaci\xf3n relevante."})]}),(0,t.jsxs)(n.Wu,{children:[(0,t.jsxs)("div",{className:"flex flex-col sm:flex-row items-center gap-4 mb-6",children:[(0,t.jsx)(o.p,{placeholder:"Buscar pedidos (Cliente, Rep)...",value:B,onChange:e=>q(e.target.value),className:"w-full sm:max-w-xs"}),(0,t.jsx)(o.p,{placeholder:"Filtrar por ciudad/provincia...",value:Y,onChange:e=>X(e.target.value),className:"w-full sm:max-w-xs"}),(0,t.jsxs)("div",{className:"flex gap-2 flex-wrap sm:flex-nowrap",children:[(0,t.jsxs)(d.rI,{children:[(0,t.jsx)(d.ty,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"outline",className:"w-full sm:w-auto",children:[(0,t.jsx)(h.A,{className:"mr-2 h-4 w-4"}),"Estado: ",J," ",(0,t.jsx)(x.A,{className:"ml-2 h-4 w-4"})]})}),(0,t.jsxs)(d.SQ,{align:"start",children:[(0,t.jsx)(d.hO,{checked:"Todos"===J,onCheckedChange:()=>H("Todos"),children:"Todos"},"Todos"),eN.filter(e=>"Todos"!==e).map(e=>(0,t.jsx)(d.hO,{checked:J===e,onCheckedChange:()=>H(e),children:e},e))]})]}),(0,t.jsxs)(S.AM,{children:[(0,t.jsx)(S.Wv,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"outline",className:(0,k.cn)("w-full sm:w-auto justify-start text-left font-normal",!$&&"text-muted-foreground"),children:[(0,t.jsx)(p.A,{className:"mr-2 h-4 w-4"}),(null==$?void 0:$.from)?$.to?(0,t.jsxs)(t.Fragment,{children:[(0,E.GP)($.from,"LLL dd, y",{locale:F.es})," -"," ",(0,E.GP)($.to,"LLL dd, y",{locale:F.es})]}):(0,E.GP)($.from,"LLL dd, y",{locale:F.es}):(0,t.jsx)("span",{children:"Seleccione un rango de fechas"})]})}),(0,t.jsx)(S.hl,{className:"w-auto p-0",align:"start",children:(0,t.jsx)(R.V,{initialFocus:!0,mode:"range",defaultMonth:null==$?void 0:$.from,selected:$,onSelect:G,numberOfMonths:2,locale:F.es})})]}),eV&&(0,t.jsxs)(r.$,{onClick:()=>{if(0===K.length)return void e({title:"No hay pedidos seleccionados",description:"Por favor, seleccione al menos un pedido para descargar.",variant:"destructive"});let a=new Map(V.map(e=>[e.id,e])),l=U.filter(e=>K.includes(e.id)),t=new Blob(["\uFEFF"+["ID Pedido,Fecha Pedido,Cliente,Nombre Fiscal,CIF,Direcci\xf3n Entrega,Direcci\xf3n Fiscal,Contacto Nombre,Contacto Email,Contacto Tel\xe9fono,Tipo Cliente,Productos (Lista),N\xba Unidades,Precio Unitario (€ sin IVA),Valor Total Pedido (€ IVA incl.),Estado Pedido,Forma de Pago,URL Factura,Nombre Archivo Factura,Comercial Asignado,Notas Pedido",...l.map(e=>{var l;let t=e.accountId?a.get(e.accountId):null;return[eD(e.id),eD(e.visitDate?(0,E.GP)((0,M.H)(e.visitDate),"dd/MM/yyyy"):""),eD(e.clientName),eD(null==t?void 0:t.legalName),eD(null==t?void 0:t.cif),eD(eL(null==t?void 0:t.addressShipping)),eD(eL(null==t?void 0:t.addressBilling)),eD(null==t?void 0:t.mainContactName),eD(null==t?void 0:t.mainContactEmail),eD(null==t?void 0:t.mainContactPhone),eD(e.clientType),eD(null==(l=e.products)?void 0:l.join("; ")),eD(e.numberOfUnits),eD(e.unitPrice),eD(e.value),eD(e.status),eD(e.paymentMethod),eD(e.invoiceUrl),eD(e.invoiceFileName),eD(e.salesRep),eD(e.notes)].join(",")})].join("\n")],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");if(void 0!==s.download){let e=URL.createObjectURL(t);s.setAttribute("href",e),s.setAttribute("download","pedidos_santabrisa_".concat((0,E.GP)(new Date,"yyyyMMdd_HHmmss"),".csv")),s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(e)}e({title:"Descarga Iniciada",description:"".concat(l.length," pedidos se est\xe1n descargando como CSV.")}),ea([])},disabled:0===K.length||L,className:"w-full sm:w-auto",children:[(0,t.jsx)(v,{className:"mr-2 h-4 w-4"}),"Descargar CSV (",K.length,")"]})]})]}),L?(0,t.jsxs)("div",{className:"flex justify-center items-center h-64",children:[(0,t.jsx)(g.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,t.jsx)("p",{className:"ml-4 text-muted-foreground",children:"Cargando pedidos..."})]}):(0,t.jsx)("div",{className:"overflow-x-auto",children:(0,t.jsxs)(i.XI,{children:[(0,t.jsx)(i.A0,{children:(0,t.jsxs)(i.Hj,{children:[eV&&(0,t.jsx)(i.nd,{className:"w-[5%] px-2",children:(0,t.jsx)(c.S,{checked:eU,onCheckedChange:e=>eF(e),"aria-label":"Seleccionar todos los pedidos filtrados"})}),(0,t.jsx)(i.nd,{className:"w-[20%]",children:"Cliente"}),(0,t.jsx)(i.nd,{className:"w-[10%]",children:"Fecha"}),(0,t.jsx)(i.nd,{className:"w-[15%]",children:"Ubicaci\xf3n (Prov/Ciudad)"}),(0,t.jsx)(i.nd,{className:"w-[15%]",children:"Comercial Asignado"}),(0,t.jsx)(i.nd,{className:"text-right w-[10%]",children:"N\xba Bot."}),(0,t.jsx)(i.nd,{className:"text-right w-[10%]",children:"Valor"}),(0,t.jsx)(i.nd,{className:"text-center w-[10%]",children:"Estado"}),(0,t.jsx)(i.nd,{className:"text-right w-[10%]",children:"Acciones"})]})}),(0,t.jsx)(i.BF,{children:ew.length>0?ew.map(e=>{var l,s;let n=e.accountId?eb.get(e.accountId):eC.get(e.clientName.toLowerCase().trim()),o=(null==n||null==(l=n.addressShipping)?void 0:l.city)||(null==n||null==(s=n.addressBilling)?void 0:s.city)||"N/D";return(0,t.jsxs)(i.Hj,{"data-state":K.includes(e.id)?"selected":"",children:[eV&&(0,t.jsx)(i.nA,{className:"px-2",children:(0,t.jsx)(c.S,{checked:K.includes(e.id),onCheckedChange:a=>ek(e.id,!!a),"aria-label":"Seleccionar pedido ".concat(e.id)})}),(0,t.jsx)(i.nA,{className:"font-medium",children:n?(0,t.jsx)(ee(),{href:"/accounts/".concat(n.id),className:"hover:underline text-primary",children:e.clientName}):e.clientName}),(0,t.jsx)(i.nA,{children:e.visitDate?(0,E.GP)((0,M.H)(e.visitDate),"dd/MM/yy",{locale:F.es}):"N/D"}),(0,t.jsxs)(i.nA,{className:"text-xs truncate max-w-[150px]",title:o,children:[(0,t.jsx)(f.A,{className:"inline-block h-3 w-3 mr-1 text-muted-foreground"}),o]}),(0,t.jsxs)(i.nA,{children:[(0,t.jsx)(y.A,{className:"inline-block h-3 w-3 mr-1 text-muted-foreground"}),e.salesRep||"N/A"]}),(0,t.jsx)(i.nA,{className:"text-right",children:(0,t.jsx)(Z.A,{value:e.numberOfUnits,locale:"es-ES",placeholder:"N/D"})}),(0,t.jsx)(i.nA,{className:"text-right",children:(0,t.jsx)(Z.A,{value:e.value,locale:"es-ES",options:{style:"currency",currency:"EUR"},placeholder:"—"})}),(0,t.jsx)(i.nA,{className:"text-center",children:ez?(0,t.jsxs)(d.rI,{children:[(0,t.jsx)(d.ty,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"ghost",className:"p-0 h-auto",children:[(0,t.jsx)(ei.A,{type:"order",status:e.status,className:"cursor-pointer"}),(0,t.jsx)(x.A,{className:"ml-1 h-3 w-3 opacity-70"})]})}),(0,t.jsx)(d.SQ,{align:"end",children:(0,t.jsx)(d.Hr,{value:e.status,onValueChange:a=>eE(e,a),children:u.X$.filter(e=>!["Programada","Seguimiento","Fallido","Completado"].includes(e)).map(e=>(0,t.jsx)(d.Ht,{value:e,children:e},e))})})]}):(0,t.jsx)(ei.A,{type:"order",status:e.status})}),(0,t.jsx)(i.nA,{className:"text-right",children:(0,t.jsxs)(d.rI,{children:[(0,t.jsx)(d.ty,{asChild:!0,children:(0,t.jsxs)(r.$,{variant:"ghost",className:"h-8 w-8 p-0",children:[(0,t.jsx)("span",{className:"sr-only",children:"Abrir men\xfa"}),(0,t.jsx)(N.A,{className:"h-4 w-4"})]})}),(0,t.jsxs)(d.SQ,{align:"end",children:[(0,t.jsxs)(d._2,{onSelect:()=>eA(e),children:[(0,t.jsx)(b.A,{className:"mr-2 h-4 w-4"})," Ver Detalles"]}),(eO||ez)&&(0,t.jsxs)(d._2,{onSelect:()=>eA(e),disabled:!eO&&!ez,children:[(0,t.jsx)(C.A,{className:"mr-2 h-4 w-4"})," Editar"]}),"Admin"===a&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.mB,{}),(0,t.jsxs)(d._2,{className:"text-destructive focus:text-destructive focus:bg-destructive/10",onSelect:a=>{a.preventDefault(),eM(e)},children:[(0,t.jsx)(w.A,{className:"mr-2 h-4 w-4"})," Eliminar Pedido"]})]}),eT&&(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(d.mB,{}),(0,t.jsxs)(en.Lt,{children:[(0,t.jsx)(en.tv,{asChild:!0,children:(0,t.jsxs)(d._2,{className:"text-destructive focus:text-destructive focus:bg-destructive/10",onSelect:a=>{a.preventDefault(),eR(e)},disabled:!eT||"Cancelado"===e.status,children:[(0,t.jsx)(A.A,{className:"mr-2 h-4 w-4"})," Cancelar Pedido"]})}),ev&&ev.id===e.id&&(0,t.jsxs)(en.EO,{children:[(0,t.jsxs)(en.wd,{children:[(0,t.jsx)(en.r7,{children:"\xbfCancelar este pedido?"}),(0,t.jsxs)(en.$v,{children:["Esta acci\xf3n no se puede deshacer. El estado del pedido para",(0,t.jsxs)("strong",{className:"mx-1",children:['"',ev.clientName,'"']}),'se cambiar\xe1 a "Cancelado". El registro no se eliminar\xe1 del historial.']})]}),(0,t.jsxs)(en.ck,{children:[(0,t.jsx)(en.Zr,{onClick:()=>eg(null),children:"Cerrar"}),(0,t.jsx)(en.Rx,{onClick:eP,variant:"destructive",children:"S\xed, cancelar pedido"})]})]})]})]})]})]})})]},e.id)}):(0,t.jsx)(i.Hj,{children:(0,t.jsx)(i.nA,{colSpan:eV?9:8,className:"h-24 text-center",children:"No se encontraron pedidos que coincidan con los filtros seleccionados."})})})]})})]}),!L&&ew.length>0&&(0,t.jsx)(n.wL,{children:(0,t.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Mostrando ",ew.length," pedidos de ",U.length," que cumplen los criterios."]})})]}),ef&&(0,t.jsx)(en.Lt,{open:!!ef,onOpenChange:e=>!e&&ey(null),children:(0,t.jsxs)(en.EO,{children:[(0,t.jsxs)(en.wd,{children:[(0,t.jsx)(en.r7,{children:"\xbfConfirmar eliminaci\xf3n?"}),(0,t.jsxs)(en.$v,{children:["Esta acci\xf3n no se puede deshacer. Se eliminar\xe1 permanentemente el pedido de ",(0,t.jsx)("strong",{children:ef.clientName}),"."]})]}),(0,t.jsxs)(en.ck,{children:[(0,t.jsx)(en.Zr,{onClick:()=>ey(null),children:"Cancelar"}),(0,t.jsx)(en.Rx,{onClick:eI,variant:"destructive",children:"S\xed, eliminar"})]})]})}),el&&a&&(0,t.jsx)(et,{order:el,isOpen:ep,onOpenChange:ej,onSave:eS,currentUserRole:a,allAccounts:V})]})}},56822:(e,a,l)=>{"use strict";l.d(a,{t:()=>s});var t=l(34477);let s=(0,t.createServerReference)("7fb93df833adc85e063ceba3b3d183c2d5c225be68",t.callServer,void 0,t.findSourceMapURL,"updateOrderStatusFS")},79557:(e,a,l)=>{"use strict";l.d(a,{r:()=>s});var t=l(34477);let s=(0,t.createServerReference)("7f889e4da298c8c8caa3b558dd449ec782a5648802",t.callServer,void 0,t.findSourceMapURL,"getOrdersFS")},83662:(e,a,l)=>{"use strict";l.d(a,{A:()=>t});let t=(0,l(40157).A)("MapPin",[["path",{d:"M20 10c0 4.993-5.539 10.193-7.399 11.799a1 1 0 0 1-1.202 0C9.539 20.193 4 14.993 4 10a8 8 0 0 1 16 0",key:"1r0f0z"}],["circle",{cx:"12",cy:"10",r:"3",key:"ilqhr7"}]])},85511:(e,a,l)=>{"use strict";l.d(a,{V:()=>o});var t=l(95155);l(12115);var s=l(965),n=l(73158),i=l(39166),r=l(59434),d=l(30285);function o(e){let{className:a,classNames:l,showOutsideDays:o=!0,...c}=e;return(0,t.jsx)(i.hv,{showOutsideDays:o,className:(0,r.cn)("p-3",a),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium",nav:"space-x-1 flex items-center",nav_button:(0,r.cn)((0,d.r)({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-muted-foreground rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:(0,r.cn)((0,d.r)({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent/40 text-accent-foreground",day_outside:"day-outside text-muted-foreground aria-selected:bg-accent/50 aria-selected:text-muted-foreground",day_disabled:"text-muted-foreground opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...l},components:{IconLeft:e=>{let{className:a,...l}=e;return(0,t.jsx)(s.A,{className:(0,r.cn)("h-4 w-4",a),...l})},IconRight:e=>{let{className:a,...l}=e;return(0,t.jsx)(n.A,{className:(0,r.cn)("h-4 w-4",a),...l})}},...c})}o.displayName="Calendar"},87489:(e,a,l)=>{"use strict";l.d(a,{b:()=>o});var t=l(12115),s=l(63655),n=l(95155),i="horizontal",r=["horizontal","vertical"],d=t.forwardRef((e,a)=>{var l;let{decorative:t,orientation:d=i,...o}=e,c=(l=d,r.includes(l))?d:i;return(0,n.jsx)(s.sG.div,{"data-orientation":c,...t?{role:"none"}:{"aria-orientation":"vertical"===c?c:void 0,role:"separator"},...o,ref:a})});d.displayName="Separator";var o=d},91721:(e,a,l)=>{"use strict";l.d(a,{A:()=>t});let t=(0,l(40157).A)("User",[["path",{d:"M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2",key:"975kel"}],["circle",{cx:"12",cy:"7",r:"4",key:"17ys0d"}]])},99058:(e,a,l)=>{"use strict";l.d(a,{k:()=>s});var t=l(34477);let s=(0,t.createServerReference)("7f0fa657ecd69c0d87ad2155db0000af563ea67f77",t.callServer,void 0,t.findSourceMapURL,"updateAccountFS")}},e=>{var a=a=>e(e.s=a);e.O(0,[2992,7138,5769,8884,1915,1490,587,7328,8965,1859,6874,6060,6764,8782,6723,3913,6315,7875,2583,8441,1684,7358],()=>a(43295)),_N_E=e.O()}]);