(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7628],{1135:(e,a,s)=>{"use strict";s.d(a,{z:()=>t});var r=s(34477);let t=(0,r.createServerReference)("7fb4c21fdd13c52ce0246c7b872e7908a18a8ba6db",r.callServer,void 0,r.findSourceMapURL,"addSupplierFS")},17972:(e,a,s)=>{"use strict";s.d(a,{G7:()=>c,L$:()=>m,h_:()=>x,oI:()=>d,uB:()=>o,xL:()=>u});var r=s(95155),t=s(12115),l=s(77740),n=s(75074),i=s(59434);s(54165);let o=t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsx)(l.uB,{ref:a,className:(0,i.cn)("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",s),...t})});o.displayName=l.uB.displayName;let c=t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsxs)("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[(0,r.jsx)(n.A,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),(0,r.jsx)(l.uB.Input,{ref:a,className:(0,i.cn)("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",s),...t})]})});c.displayName=l.uB.Input.displayName;let d=t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsx)(l.uB.List,{ref:a,className:(0,i.cn)("max-h-[300px] overflow-y-auto overflow-x-hidden",s),...t})});d.displayName=l.uB.List.displayName;let u=t.forwardRef((e,a)=>(0,r.jsx)(l.uB.Empty,{ref:a,className:"py-6 text-center text-sm",...e}));u.displayName=l.uB.Empty.displayName;let m=t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsx)(l.uB.Group,{ref:a,className:(0,i.cn)("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",s),...t})});m.displayName=l.uB.Group.displayName,t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsx)(l.uB.Separator,{ref:a,className:(0,i.cn)("-mx-1 h-px bg-border",s),...t})}).displayName=l.uB.Separator.displayName;let x=t.forwardRef((e,a)=>{let{className:s,...t}=e;return(0,r.jsx)(l.uB.Item,{ref:a,className:(0,i.cn)("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none aria-selected:bg-accent aria-selected:text-accent-foreground data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50",s),...t})});x.displayName=l.uB.Item.displayName},75119:(e,a,s)=>{"use strict";s.r(a),s.d(a,{default:()=>el});var r=s(95155),t=s(12115),l=s(30285),n=s(66695),i=s(85127),o=s(44838),c=s(62523),d=s(47262),u=s(87481),m=s(51055),x=s(59114),h=s(50172),p=s(74601),j=s(34301),v=s(9572),f=s(79556),g=s(77223),N=s(3561),b=s(54165),y=s(17759),w=s(15300),S=s(86950),C=s(21887),A=s(10518),I=s(32137),E=s(19591),R=s(59409),k=s(61930),B=s(14636),L=s(17972),U=s(62177),_=s(90221),M=s(68663),P=s(21141),O=s(34477);let G=(0,O.createServerReference)("7f48946820d2cb55bdccf7a32cc4d70aa9eedca757",O.callServer,void 0,O.findSourceMapURL,"addPurchaseFS");var T=s(19564),$=s(31013),z=s(96153),F=s(1135);let D=M.vk(e=>""===e||null===e?void 0:Number(e),M.ai({invalid_type_error:"Debe ser un n\xfamero"}).nonnegative("No puede ser negativo").optional().nullable()),J=M.Ik({productoId:M.Yj().min(1,"Debe seleccionar un art\xedculo."),cantidad:D.refine(e=>null!=e&&e>0,{message:"Cantidad debe ser positiva."}),costeUnitario:D.refine(e=>null!=e,{message:"Coste es obligatorio."}),costeUnitarioProrrateado:M.au.number().optional()}),V=M.Ik({categoriaId:M.Yj({required_error:"Debe seleccionar una categor\xeda."}),proveedorId:M.Yj().optional(),proveedorNombre:M.Yj().optional(),invoiceNumber:M.Yj().optional(),afectaInventario:M.zM().default(!1),items:M.YO(J).optional(),gastosEnvio:D,impuestos:D}),W={categoriaId:"",proveedorId:"",proveedorNombre:"",invoiceNumber:"",afectaInventario:!1,items:[],gastosEnvio:null,impuestos:null};var Y=s(59434),q=s(55465),Z=s(61017);function H(e){var a;let{field:s,...t}=e,{ref:l,...n}=s;return(0,r.jsx)(c.p,{type:"number",step:"0.01",ref:l,...n,...t,value:null!=(a=s.value)?a:"",onChange:e=>{let a=e.target.value;s.onChange(""===a?null:Number(a))}})}function Q(e){let{isOpen:a,onOpenChange:s,initialData:n}=e,{form:i,onSubmit:o,isSaving:x,isLoading:p,costCategories:v,inventoryCategories:f,inventoryItems:N,suppliers:M,watchedAfectaInventario:O,watchedItems:D,fields:J,append:Q,remove:X,update:K,calculatedTotal:ee,itemsSubtotal:ea,isNewSupplierDialogOpen:es,setIsNewSupplierDialogOpen:er,handleNewSupplier:et,handleSaveNewSupplier:el,supplierSearch:en,setSupplierSearch:ei,openSupplierCombo:eo,setOpenSupplierCombo:ec,isNewItemDialogOpen:ed,setIsNewItemDialogOpen:eu,handleNewItem:em,handleSaveNewItem:ex,newItemInitialName:eh,setNewItemInitialName:ep,itemSearch:ej,setItemSearch:ev,NEW_ITEM_SENTINEL:ef,NEW_SUPPLIER_SENTINEL:eg}=function(e){let{isOpen:a,onOpenChange:s,initialData:r}=e,{toast:l}=(0,u.dj)(),{user:n,teamMember:i,refreshDataSignature:o}=(0,m.A)(),{inventoryCategories:c=[],costCategories:d=[],allCategories:x=[]}=(0,P.Ck)(),[h,p]=t.useState([]),[j,v]=t.useState([]),[f,g]=t.useState(!1),[N,b]=t.useState(!1),[y,w]=t.useState(!1),[S,C]=t.useState(!1),[A,I]=t.useState(null),[E,R]=t.useState(""),[k,B]=t.useState(""),[L,M]=t.useState(""),[O,D]=t.useState(!1),J=(0,U.mN)({resolver:(0,_.u)(V),defaultValues:r?{...W,...r}:W}),{setValue:Y,control:q,reset:Z,watch:H,trigger:Q}=J,X=H("afectaInventario"),K=H("items"),ee=H("gastosEnvio"),ea=H("impuestos"),es=H("categoriaId"),{fields:er,append:et,remove:el,update:en}=(0,U.jz)({control:q,name:"items"}),ei=t.useMemo(()=>{var e;return null!=(e=null==K?void 0:K.reduce((e,a)=>e+(Number(a.costeUnitario)||0)*(Number(a.cantidad)||0),0))?e:0},[K]),eo=t.useMemo(()=>ei+(Number(ee)||0)+(Number(ea)||0),[ei,ee,ea]);t.useEffect(()=>{ei>0&&K&&Y("items",K.map(e=>{let a=(Number(e.cantidad)||0)*(Number(e.costeUnitario)||0),s=ei>0?a/ei:0,r=(Number(ee)||0)*s,t=(Number(ea)||0)*s,l=(e.cantidad||0)>0?(a+r+t)/e.cantidad:0;return{...e,costeUnitarioProrrateado:l}}))},[ei,ee,ea,Y,K]),t.useEffect(()=>{let e=!0;return async function(){if(a){g(!0);try{let[a,s]=await Promise.all([(0,T.y)(),(0,z.d)()]);e&&(p(a),v(s))}catch(e){l({title:"Error",description:"No se pudieron cargar datos.",variant:"destructive"})}finally{e&&g(!1)}}}(),()=>{e=!1}},[a,l]);let ec=t.useMemo(()=>x.find(e=>e.id===es),[x,es]);t.useEffect(()=>{ec&&Y("afectaInventario","inventory"===ec.kind)},[ec,Y]),t.useEffect(()=>{if(a)if(r){var e;let a=j.find(e=>e.name===r.supplierName||e.cif===r.supplierTaxId),s=(null==(e=r.items)?void 0:e.map(e=>{var a,s;return{productoId:"",cantidad:null!=(a=e.quantity)?a:null,costeUnitario:null!=(s=e.unitPrice)?s:null,costeUnitarioProrrateado:0}}))||[];Z({...W,proveedorId:(null==a?void 0:a.id)||void 0,proveedorNombre:r.supplierName,invoiceNumber:r.invoiceId,items:s,gastosEnvio:r.shippingCost,impuestos:r.tax})}else Z(W);else Z(W)},[a,r,Z,j]);let ed=async e=>{let a=await (0,F.z)(e);if(a){let s={id:a,...e};return v(e=>[s,...e]),J.setValue("proveedorId",a),w(!1),D(!1),s}return null},eu=async e=>{let a=await (0,$.U)(e);if(a&&a.id){let s={id:a.id,...e};return p(e=>[s,...e]),null!==A&&en(A,{productoId:a.id,cantidad:null,costeUnitario:null,costeUnitarioProrrateado:0}),C(!1),I(null),{id:a.id,sku:a.sku,name:a.name}}return null};return{form:J,onSubmit:async e=>{if(!n||!i)return;let a=i.id;b(!0);try{await G(e,a),l({title:"Registro Creado",description:"El gasto/compra se ha guardado correctamente."}),o(),s(!1)}catch(e){l({title:"Error al Guardar",description:e.message,variant:"destructive"})}finally{b(!1)}},isSaving:N,isLoading:f,costCategories:d,inventoryCategories:c,inventoryItems:h,suppliers:j,watchedAfectaInventario:X,watchedItems:K,fields:er,append:()=>et({productoId:"",cantidad:null,costeUnitario:null,costeUnitarioProrrateado:0}),remove:el,update:en,calculatedTotal:eo,isNewSupplierDialogOpen:y,setIsNewSupplierDialogOpen:w,handleNewSupplier:function(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";D(!1),R(e),w(!0)},handleSaveNewSupplier:ed,supplierSearch:k,setSupplierSearch:B,openSupplierCombo:O,setOpenSupplierCombo:D,isNewItemDialogOpen:S,setIsNewItemDialogOpen:C,handleNewItem:function(e){let a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";I(e),R(a),C(!0)},handleSaveNewItem:eu,newItemInitialName:E,setNewItemInitialName:R,itemSearch:L,setItemSearch:M,itemsSubtotal:ei,NEW_ITEM_SENTINEL:"##NEW##",NEW_SUPPLIER_SENTINEL:"##NEW_SUPPLIER##"}}({isOpen:a,onOpenChange:s,initialData:n}),{control:eN,watch:eb}=i;return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(b.lG,{open:a,onOpenChange:s,children:(0,r.jsxs)(b.Cf,{className:"sm:max-w-4xl max-h-[90vh] overflow-y-auto",children:[(0,r.jsxs)(b.c7,{children:[(0,r.jsx)(b.L3,{children:"Registrar Gasto o Compra"}),(0,r.jsx)(b.rr,{children:"Completa los detalles. Los campos se adaptar\xe1n seg\xfan tus selecciones."})]}),p?(0,r.jsx)("div",{className:"flex justify-center items-center h-48",children:(0,r.jsx)(h.A,{className:"h-8 w-8 animate-spin text-primary"})}):(0,r.jsx)(y.lV,{...i,children:(0,r.jsxs)("form",{onSubmit:i.handleSubmit(o),className:"space-y-6",children:[(0,r.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2 pt-2 border-t",children:[(0,r.jsx)(w.A,{className:"h-5 w-5 text-primary"})," Informaci\xf3n General"]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsx)(y.zB,{control:eN,name:"categoriaId",render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"Categor\xeda *"}),(0,r.jsxs)(R.l6,{onValueChange:a.onChange,value:a.value,children:[(0,r.jsx)(y.MJ,{children:(0,r.jsx)(R.bq,{children:(0,r.jsx)(R.yv,{placeholder:"Selecciona una categor\xeda..."})})}),(0,r.jsxs)(R.gC,{children:[v.length>0&&(0,r.jsxs)(R.s3,{children:[(0,r.jsx)(y.lR,{className:"px-2 text-xs text-muted-foreground",children:"Gastos Generales"}),v.map(e=>(0,r.jsx)(R.eb,{value:e.id,children:e.name},e.id))]}),f.length>0&&(0,r.jsxs)(R.s3,{children:[(0,r.jsx)(y.lR,{className:"px-2 text-xs text-muted-foreground",children:"Compras de Inventario"}),f.map(e=>(0,r.jsx)(R.eb,{value:e.id,children:e.name},e.id))]})]})]}),(0,r.jsx)(y.C5,{})]})}}),(0,r.jsx)(y.zB,{control:i.control,name:"invoiceNumber",render:e=>{var a;let{field:s}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"N\xfamero de Factura (Opcional)"}),(0,r.jsx)(y.MJ,{children:(0,r.jsx)(c.p,{placeholder:"Ej: F2024-00123",...s,value:null!=(a=s.value)?a:""})}),(0,r.jsx)(y.C5,{})]})}})]}),(0,r.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2 pt-2 border-t",children:[(0,r.jsx)(S.A,{className:"h-5 w-5 text-primary"})," Datos del Proveedor"]}),(0,r.jsx)(y.zB,{control:eN,name:"proveedorId",render:e=>{var a;let{field:s}=e;return(0,r.jsxs)(y.eI,{className:"flex flex-col",children:[(0,r.jsx)(y.lR,{children:"Proveedor"}),(0,r.jsxs)(B.AM,{open:eo,onOpenChange:ec,children:[(0,r.jsx)(B.Wv,{asChild:!0,children:(0,r.jsx)(y.MJ,{children:(0,r.jsxs)(l.$,{variant:"outline",role:"combobox",className:(0,Y.cn)("w-full justify-between",!s.value&&"text-muted-foreground"),children:[s.value?null==(a=M.find(e=>e.id===s.value))?void 0:a.name:"Seleccionar o crear proveedor...",(0,r.jsx)(C.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),(0,r.jsx)(B.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:(0,r.jsxs)(L.uB,{children:[(0,r.jsx)(L.G7,{placeholder:"Buscar proveedor...",value:en,onValueChange:ei}),(0,r.jsxs)(L.oI,{children:[(0,r.jsx)(L.xL,{children:(0,r.jsxs)(l.$,{variant:"ghost",className:"w-full",onClick:()=>et(en),children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"}),' Crear "',en,'"']})}),(0,r.jsxs)(L.L$,{children:[(0,r.jsxs)(L.h_,{value:eg,onSelect:()=>et(en),children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Crear nuevo proveedor"]}),M.map(e=>(0,r.jsxs)(L.h_,{value:e.id,onSelect:()=>{i.setValue("proveedorId",e.id),ec(!1)},children:[(0,r.jsx)(A.A,{className:(0,Y.cn)("mr-2 h-4 w-4",e.id===s.value?"opacity-100":"opacity-0")}),e.name]},e.id))]})]})]})})]}),(0,r.jsx)(y.C5,{})]})}}),(0,r.jsx)(y.zB,{control:i.control,name:"afectaInventario",render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{className:"flex flex-row items-center space-x-3 space-y-0 rounded-md border p-4 shadow-sm bg-muted/30 pt-6",children:[(0,r.jsx)(y.MJ,{children:(0,r.jsx)(d.S,{checked:a.value,onCheckedChange:a.onChange})}),(0,r.jsxs)("div",{className:"space-y-1 leading-none",children:[(0,r.jsxs)(y.lR,{className:"flex items-center gap-2",children:[(0,r.jsx)(I.A,{className:"h-5 w-5 text-primary"})," \xbfAfecta a Inventario?"]}),(0,r.jsx)(y.Rr,{children:"Marca esta opci\xf3n si el gasto es una compra de stock. La opci\xf3n est\xe1 vinculada a la categor\xeda."})]})]})}}),O&&(0,r.jsxs)("div",{className:"p-4 border rounded-md space-y-4 bg-secondary/20",children:[(0,r.jsx)("div",{className:"max-h-56 overflow-y-auto pr-2 space-y-3",children:J.map((e,a)=>(eb("items.".concat(a,".productoId")),(0,r.jsxs)("div",{className:"p-3 border rounded-md relative space-y-2 bg-background",children:[(0,r.jsx)(l.$,{"aria-label":"Eliminar art\xedculo",type:"button",variant:"ghost",size:"icon",onClick:()=>X(a),className:"absolute top-1 right-1 h-6 w-6 text-muted-foreground hover:bg-destructive/10 hover:text-destructive",children:(0,r.jsx)(g.A,{className:"h-4 w-4"})}),(0,r.jsx)(y.zB,{control:eN,name:"items.".concat(a,".productoId"),render:e=>{var s;let{field:t}=e;return(0,r.jsxs)(y.eI,{className:"flex flex-col",children:[(0,r.jsx)(y.lR,{className:"flex items-center gap-1",children:"Art\xedculo *"}),(0,r.jsxs)(B.AM,{children:[(0,r.jsx)(B.Wv,{asChild:!0,children:(0,r.jsx)(y.MJ,{children:(0,r.jsxs)(l.$,{variant:"outline",role:"combobox",className:(0,Y.cn)("w-full justify-between",!t.value&&"text-muted-foreground"),children:[t.value?null==(s=N.find(e=>e.id===t.value))?void 0:s.name:"Seleccionar o crear art\xedculo...",(0,r.jsx)(C.A,{className:"ml-2 h-4 w-4 shrink-0 opacity-50"})]})})}),(0,r.jsx)(B.hl,{className:"w-[--radix-popover-trigger-width] p-0",children:(0,r.jsxs)(L.uB,{children:[(0,r.jsx)(L.G7,{placeholder:"Buscar art\xedculo...",value:ej,onValueChange:ev}),(0,r.jsxs)(L.oI,{children:[(0,r.jsx)(L.xL,{children:(0,r.jsxs)(l.$,{variant:"ghost",className:"w-full",onClick:()=>em(a,ej),children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"}),'Crear "',ej,'"']})}),(0,r.jsxs)(L.L$,{children:[(0,r.jsxs)(L.h_,{value:ef,onSelect:()=>em(a,ej),children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"}),"Crear nuevo art\xedculo"]}),N.map(e=>(0,r.jsxs)(L.h_,{value:e.id,onSelect:()=>i.setValue("items.".concat(a,".productoId"),e.id),children:[(0,r.jsx)(A.A,{className:(0,Y.cn)("mr-2 h-4 w-4",e.id===t.value?"opacity-100":"opacity-0")}),e.name]},e.id))]})]})]})})]}),(0,r.jsx)(y.C5,{})]})}}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsx)(y.zB,{control:eN,name:"items.".concat(a,".cantidad"),render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"Cantidad *"}),(0,r.jsx)(y.MJ,{children:(0,r.jsx)(H,{field:a})}),(0,r.jsx)(y.C5,{})]})}}),(0,r.jsx)(y.zB,{control:eN,name:"items.".concat(a,".costeUnitario"),render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"Coste Unitario (€) *"}),(0,r.jsx)(y.MJ,{children:(0,r.jsx)(H,{field:a})}),(0,r.jsx)(y.C5,{})]})}})]})]},e.id)))}),(0,r.jsxs)(l.$,{"aria-label":"A\xf1adir art\xedculo",type:"button",variant:"outline",size:"sm",onClick:()=>Q({productoId:"",cantidad:null,costeUnitario:null,costeUnitarioProrrateado:0}),children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"})," A\xf1adir Art\xedculo"]})]}),(0,r.jsxs)("h3",{className:"text-lg font-semibold flex items-center gap-2 pt-2 border-t",children:[(0,r.jsx)(E.A,{className:"h-5 w-5 text-primary"})," Desglose Econ\xf3mico"]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,r.jsx)(y.zB,{control:i.control,name:"gastosEnvio",render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"Gastos de Env\xedo (€)"}),(0,r.jsx)(y.MJ,{children:(0,r.jsx)(H,{field:a})}),(0,r.jsx)(y.C5,{})]})}}),(0,r.jsx)(y.zB,{control:i.control,name:"impuestos",render:e=>{let{field:a}=e;return(0,r.jsxs)(y.eI,{children:[(0,r.jsx)(y.lR,{children:"Impuestos (IVA, etc. en €)"}),(0,r.jsx)(y.MJ,{children:(0,r.jsx)(H,{field:a})}),(0,r.jsx)(y.C5,{})]})}})]}),(0,r.jsx)("div",{className:"p-4 bg-muted rounded-md space-y-2",children:(0,r.jsxs)("div",{className:"flex justify-between text-lg font-bold",children:[(0,r.jsx)("span",{className:"text-foreground",children:"TOTAL:"}),(0,r.jsx)(k.A,{value:ee,options:{style:"currency",currency:"EUR"}})]})}),(0,r.jsxs)(b.Es,{className:"pt-4",children:[(0,r.jsx)(b.HM,{asChild:!0,children:(0,r.jsx)(l.$,{type:"button",variant:"outline",disabled:x,children:"Cancelar"})}),(0,r.jsx)(l.$,{type:"submit",disabled:x||p,children:x?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(h.A,{className:"mr-2 h-4 w-4 animate-spin"}),"Guardando..."]}):"Guardar Registro"})]})]})})]})}),(0,r.jsx)(q.A,{supplier:null,isOpen:es,onOpenChange:er,onSave:el}),(0,r.jsx)(Z.A,{item:null,isOpen:ed,onOpenChange:eu,onSave:ex})]})}var X=s(90010),K=s(96656);let ee=(0,O.createServerReference)("7fa84ba51591183ebd284a6c9eaba1d5ce27648cf0",O.callServer,void 0,O.findSourceMapURL,"getExpensesFS"),ea=(0,O.createServerReference)("7f88383a345c29bd8233f2a84661e50ecb73b84fc5",O.callServer,void 0,O.findSourceMapURL,"deleteExpensesBatchFS"),es=(0,O.createServerReference)("40591b89503a0e45d423187a8899a1eb2873ef1fcb",O.callServer,void 0,O.findSourceMapURL,"processInvoice"),er=["proforma","factura_pendiente","factura_recibida","factura_validada"],et=["pendiente","parcial","pagado"];function el(){let{toast:e}=(0,u.dj)(),{userRole:a,dataSignature:s,refreshDataSignature:b}=(0,m.A)(),{categoriesMap:y,isLoading:w}=(0,P.Ck)(),[S,C]=t.useState([]),[A,I]=t.useState(!0),[E,R]=t.useState(!1),[B,L]=t.useState(null),[U,_]=t.useState(!1),[M,O]=t.useState(null),[G,T]=t.useState([]),[$,z]=t.useState(""),[F,D]=t.useState("Todos"),[J,V]=t.useState("Todos"),[W,Y]=t.useState([]),q=t.useRef(null),Z="Admin"===a,H=A||w;t.useEffect(()=>{async function a(){I(!0);try{let e=await ee();C(e)}catch(a){console.error("Failed to load expenses:",a),e({title:"Error",description:"No se pudieron cargar los gastos.",variant:"destructive"})}finally{I(!1)}}Z?a():I(!1)},[e,Z,s]);let el=async a=>{var s;let r=null==(s=a.target.files)?void 0:s[0];if(r){_(!0),e({title:"Procesando factura...",description:"La IA est\xe1 analizando el documento. Esto puede tardar unos segundos."});try{let a=new FileReader;a.readAsDataURL(r),a.onload=async()=>{let s=a.result,r=await es({invoiceDataUri:s});L(r),R(!0),e({title:"\xa1Factura Procesada!",description:"Revisa y ajusta los datos extra\xeddos por la IA."})},a.onerror=e=>{throw Error("Error al leer el archivo.")}}catch(a){console.error("Error processing invoice:",a),e({title:"Error al Procesar Factura",description:a.message,variant:"destructive"})}finally{_(!1),q.current&&(q.current.value="")}}},en=async()=>{if(Z&&0!==G.length){I(!0);try{await ea(G),e({title:"\xa1Gastos Eliminados!",description:"".concat(G.length," gastos han sido eliminados."),variant:"destructive"}),b(),Y([])}catch(a){e({title:"Error al Eliminar",description:a.message,variant:"destructive"})}finally{I(!1),T([])}}},ei=S.filter(e=>e.proveedorNombre&&e.proveedorNombre.toLowerCase().includes($.toLowerCase())).filter(e=>"Todos"===F||e.estadoDocumento===F).filter(e=>"Todos"===J||e.estadoPago===J),eo=(e,a)=>{a?Y(a=>[...a,e]):Y(a=>a.filter(a=>a!==e))},ec=t.useMemo(()=>{let e=new Set(ei.map(e=>e.id)),a=W.filter(a=>e.has(a));return 0!==a.length&&0!==ei.length&&(a.length===ei.length||"indeterminate")},[W,ei]);return Z?(0,r.jsxs)("div",{className:"space-y-8",children:[(0,r.jsxs)("header",{className:"flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center space-x-2",children:[(0,r.jsx)(x.A,{className:"h-8 w-8 text-primary"}),(0,r.jsx)("h1",{className:"text-3xl font-headline font-semibold",children:"Gesti\xf3n de Gastos y Compras"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-wrap justify-end",children:[(0,r.jsx)("input",{type:"file",ref:q,onChange:el,className:"hidden",accept:"image/*,application/pdf"}),(0,r.jsxs)(l.$,{onClick:()=>{var e;return null==(e=q.current)?void 0:e.click()},disabled:H||U,variant:"secondary",children:[U?(0,r.jsx)(h.A,{className:"mr-2 h-4 w-4 animate-spin"}):(0,r.jsx)(p.A,{className:"mr-2 h-4 w-4"}),"Subir Factura (IA)"]}),(0,r.jsxs)(l.$,{onClick:()=>{Z&&(L(null),R(!0))},disabled:H||U,children:[(0,r.jsx)(j.A,{className:"mr-2 h-4 w-4"})," Registrar Manualmente"]})]})]}),(0,r.jsxs)(n.Zp,{className:"shadow-subtle hover:shadow-md transition-shadow duration-300",children:[(0,r.jsxs)(n.aR,{children:[(0,r.jsx)(n.ZB,{children:"Listado de Gastos Registrados"}),(0,r.jsx)(n.BT,{children:"Administra las compras, gastos generales, proformas y proyecciones."})]}),(0,r.jsxs)(n.Wu,{children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-center gap-4 mb-6",children:[(0,r.jsx)(c.p,{placeholder:"Buscar por proveedor...",value:$,onChange:e=>z(e.target.value),className:"max-w-sm"}),(0,r.jsxs)(o.rI,{children:[(0,r.jsx)(o.ty,{asChild:!0,children:(0,r.jsxs)(l.$,{variant:"outline",className:"w-full sm:w-auto",children:[(0,r.jsx)(v.A,{className:"mr-2 h-4 w-4"}),"Estado Doc: ",F," ",(0,r.jsx)(f.A,{className:"ml-2 h-4 w-4"})]})}),(0,r.jsxs)(o.SQ,{align:"start",children:[(0,r.jsx)(o.hO,{onSelect:()=>D("Todos"),checked:"Todos"===F,children:"Todos"}),er.map(e=>(0,r.jsx)(o.hO,{onSelect:()=>D(e),checked:F===e,children:e},e))]})]}),(0,r.jsxs)(o.rI,{children:[(0,r.jsx)(o.ty,{asChild:!0,children:(0,r.jsxs)(l.$,{variant:"outline",className:"w-full sm:w-auto",children:[(0,r.jsx)(v.A,{className:"mr-2 h-4 w-4"}),"Estado Pago: ",J," ",(0,r.jsx)(f.A,{className:"ml-2 h-4 w-4"})]})}),(0,r.jsxs)(o.SQ,{align:"start",children:[(0,r.jsx)(o.hO,{onSelect:()=>V("Todos"),checked:"Todos"===J,children:"Todos"}),et.map(e=>(0,r.jsx)(o.hO,{onSelect:()=>V(e),checked:J===e,children:e},e))]})]}),W.length>0&&(0,r.jsxs)(l.$,{variant:"destructive",onClick:()=>{Z&&0!==W.length&&T(W)},className:"ml-auto",children:[(0,r.jsx)(g.A,{className:"mr-2 h-4 w-4"}),"Eliminar (",W.length,")"]})]}),H?(0,r.jsxs)("div",{className:"flex justify-center items-center h-64",children:[(0,r.jsx)(h.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,r.jsx)("p",{className:"ml-4 text-muted-foreground",children:"Cargando gastos..."})]}):(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)(i.XI,{children:[(0,r.jsx)(i.A0,{children:(0,r.jsxs)(i.Hj,{children:[(0,r.jsx)(i.nd,{className:"w-[40px]",children:(0,r.jsx)(d.S,{checked:ec,onCheckedChange:e=>{!0===e?Y(ei.map(e=>e.id)):Y([])},"aria-label":"Seleccionar todas"})}),(0,r.jsx)(i.nd,{children:"Concepto / Factura"}),(0,r.jsx)(i.nd,{children:"Proveedor"}),(0,r.jsx)(i.nd,{children:"Periodo"}),(0,r.jsx)(i.nd,{className:"text-right",children:"Importe"}),(0,r.jsx)(i.nd,{children:"Estado Doc."}),(0,r.jsx)(i.nd,{children:"Estado Pago"}),(0,r.jsx)(i.nd,{className:"text-right",children:"Acciones"})]})}),(0,r.jsx)(i.BF,{children:ei.length>0?ei.map(e=>(0,r.jsxs)(i.Hj,{"data-state":W.includes(e.id)?"selected":"",children:[(0,r.jsx)(i.nA,{children:(0,r.jsx)(d.S,{checked:W.includes(e.id),onCheckedChange:a=>eo(e.id,!!a),"aria-label":"Seleccionar gasto ".concat(e.id)})}),(0,r.jsx)(i.nA,{className:"font-medium",children:e.invoiceNumber||y.get(e.categoriaId)||e.categoria}),(0,r.jsx)(i.nA,{children:e.proveedorNombre||"N/A"}),(0,r.jsx)(i.nA,{children:e.periodo}),(0,r.jsx)(i.nA,{className:"text-right",children:(0,r.jsx)(k.A,{value:e.monto,options:{style:"currency",currency:"EUR"}})}),(0,r.jsx)(i.nA,{children:(0,r.jsx)(K.A,{type:"document",status:e.estadoDocumento})}),(0,r.jsx)(i.nA,{children:(0,r.jsx)(K.A,{type:"payment",status:e.estadoPago})}),(0,r.jsx)(i.nA,{className:"text-right",children:(0,r.jsx)(l.$,{variant:"ghost",size:"icon",children:(0,r.jsx)(N.A,{className:"h-4 w-4"})})})]},e.id)):(0,r.jsx)(i.Hj,{children:(0,r.jsx)(i.nA,{colSpan:8,className:"text-center h-24",children:"No se encontraron gastos que coincidan con tu b\xfasqueda."})})})]})})]}),!H&&ei.length>0&&(0,r.jsx)(n.wL,{children:(0,r.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Total de gastos mostrados: ",ei.length," de ",S.length]})})]}),(0,r.jsx)(X.Lt,{open:G.length>0,onOpenChange:e=>!e&&T([]),children:(0,r.jsxs)(X.EO,{children:[(0,r.jsxs)(X.wd,{children:[(0,r.jsxs)(X.r7,{children:["\xbfEliminar ",G.length," gastos?"]}),(0,r.jsx)(X.$v,{children:"Esta acci\xf3n no se puede deshacer y eliminar\xe1 permanentemente los gastos seleccionados."})]}),(0,r.jsxs)(X.ck,{children:[(0,r.jsx)(X.Zr,{onClick:()=>T([]),children:"Cancelar"}),(0,r.jsx)(X.Rx,{onClick:en,variant:"destructive",children:"S\xed, eliminar"})]})]})}),(0,r.jsx)(Q,{isOpen:E,onOpenChange:R,initialData:B})]}):(0,r.jsxs)(n.Zp,{className:"shadow-subtle",children:[(0,r.jsx)(n.aR,{children:(0,r.jsx)(n.ZB,{className:"flex items-center",children:"Acceso Denegado"})}),(0,r.jsx)(n.Wu,{children:(0,r.jsx)("p",{children:"No tienes permiso para acceder a esta secci\xf3n."})})]})}},96153:(e,a,s)=>{"use strict";s.d(a,{d:()=>t});var r=s(34477);let t=(0,r.createServerReference)("7fedd4cc0e1d5efab5751b9e9214f2a25d5d9d7a93",r.callServer,void 0,r.findSourceMapURL,"getSuppliersFS")},99425:(e,a,s)=>{Promise.resolve().then(s.bind(s,75119))}},e=>{var a=a=>e(e.s=a);e.O(0,[2992,7138,5769,8884,1915,1490,587,7328,8965,1859,6764,8782,1309,7555,6315,7875,5465,3778,8441,1684,7358],()=>a(99425)),_N_E=e.O()}]);