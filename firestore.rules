rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regla por defecto: denegar todo
    match /{document=**} {
      allow read, write: if false;
    }

    // Permite la lectura en colecciones principales si el usuario está autenticado.
    // La escritura sigue siendo restringida.
    match /teamMembers/{userId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    match /accounts/{accountId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null; // Se podría restringir más adelante a roles
    }
    
    match /orders/{orderId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }

    match /events/{eventId} {
        allow read: if request.auth != null;
        allow write: if request.auth != null;
    }
    
    match /categories/{categoryId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.admin == true;
    }

    match /inventoryItems/{itemId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.admin == true;
    }
    
    match /itemBatches/{batchId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }

    match /stockTxns/{txnId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
    
    match /purchases/{purchaseId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.admin == true;
    }
    
    match /suppliers/{supplierId} {
        allow read: if request.auth != null;
        allow write: if request.auth.token.admin == true;
    }

    match /productionRuns/{runId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }

    match /tanks/{tankId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
    
    match /bomLines/{bomId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
    
    match /directSales/{saleId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true || request.auth.token.role == 'Distributor';
    }

    match /sampleRequests/{reqId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
    
    match /stickyNotes/{noteId} {
        allow read, write: if request.auth != null && request.auth.uid == resource.data.creatorId;
        allow read, write: if request.auth != null && request.auth.uid == resource.data.assignedToId;
        allow read, delete: if request.auth.token.admin == true;
    }

    // Colecciones de solo-lectura para datos públicos (si las hubiera)
    // match /publicData/{docId} {
    //  allow read: if true;
    // }
    
    // Colecciones de solo-admin
    match /counters/{counterId} {
      allow read, write: if request.auth.token.admin == true;
    }
    
    match /settings/{settingsId} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }
    
     match /migrationFlags/{flagId} {
      allow read, write: if request.auth.token.admin == true;
    }
  }
}
