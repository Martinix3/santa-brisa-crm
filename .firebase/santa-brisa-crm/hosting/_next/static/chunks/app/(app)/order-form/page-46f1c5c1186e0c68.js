(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[621],{15300:(e,a,i)=>{"use strict";i.d(a,{A:()=>n});let n=(0,i(40157).A)("FileText",[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]])},19564:(e,a,i)=>{"use strict";i.d(a,{y:()=>t});var n=i(34477);let t=(0,n.createServerReference)("7f1e87e0573a6b4c8c91b413e52b517bc8f151c7f9",n.callServer,void 0,n.findSourceMapURL,"getInventoryItemsFS")},40020:(e,a,i)=>{"use strict";i.r(a),i.d(a,{default:()=>en});var n=i(95155),t=i(12115),s=i(1978),l=i(60760),r=i(66695),o=i(17759),c=i(50172),d=i(15300),u=i(62177),m=i(90221),x=i(87481),p=i(35695),h=i(51055),j=i(65331),v=i(16021),f=i(19564),g=i(34477);let b=(0,g.createServerReference)("7fffaeae4f4efb4b1f20275ffd382e1d2383e552ab",g.callServer,void 0,g.findSourceMapURL,"getOrderByIdFS");var y=i(35317),C=i(56104),N=i(68663),I=i(93473);let F="##NONE##",w="##ADMIN_SELF##",R=N.Ik({materialId:N.Yj().min(1,"Debe seleccionar un material."),quantity:N.au.number().min(1,"La cantidad debe ser al menos 1.").optional()}),E=N.Ik({userRole:N.k5(I.RP).nullable(),isNewClient:N.zM().default(!1),outcome:N.k5(["successful","failed","follow-up"]).optional(),clavadistaId:N.Yj().optional(),selectedSalesRepId:N.Yj().optional(),clavadistaSelectedSalesRepId:N.Yj().optional(),canalOrigenColocacion:N.k5(I.QZ).optional(),paymentMethod:N.k5(I.IJ).optional(),iban:N.Yj().optional(),clientType:N.k5(I.QM).optional(),numberOfUnits:N.au.number().optional(),unitPrice:N.au.number().optional(),nombreFiscal:N.Yj().optional(),cif:N.Yj().optional(),direccionFiscal_street:N.Yj().optional(),direccionFiscal_number:N.Yj().optional(),direccionFiscal_city:N.Yj().optional(),direccionFiscal_province:N.Yj().optional(),direccionFiscal_postalCode:N.Yj().optional(),direccionFiscal_country:N.Yj().optional(),sameAsBilling:N.zM().optional(),direccionEntrega_street:N.Yj().optional(),direccionEntrega_number:N.Yj().optional(),direccionEntrega_city:N.Yj().optional(),direccionEntrega_province:N.Yj().optional(),direccionEntrega_postalCode:N.Yj().optional(),direccionEntrega_country:N.Yj().optional(),contactoNombre:N.Yj().optional(),contactoCorreo:N.Yj().email("Formato de correo no v\xe1lido.").optional().or(N.eu("")),contactoTelefono:N.Yj().optional(),observacionesAlta:N.Yj().optional(),nextActionType:N.k5(I.Cv).optional(),nextActionCustom:N.Yj().optional(),nextActionDate:N.p6().optional(),failureReasonType:N.k5(I.HF).optional(),failureReasonCustom:N.Yj().optional(),notes:N.Yj().optional(),assignedMaterials:N.YO(R).optional()}).superRefine((e,a)=>{if("successful"===e.outcome&&((!e.numberOfUnits||e.numberOfUnits<=0)&&a.addIssue({path:["numberOfUnits"],message:"Unidades son obligatorias"}),(!e.unitPrice||e.unitPrice<=0)&&a.addIssue({path:["unitPrice"],message:"Precio es obligatorio"}),e.paymentMethod||a.addIssue({path:["paymentMethod"],message:"Forma de pago es obligatoria."}),"Giro Bancario"!==e.paymentMethod||e.iban&&/^[A-Z]{2}[0-9]{2}[0-9A-Z]{1,30}$/.test(e.iban.replace(/\s/g,""))||a.addIssue({path:["iban"],message:"IBAN v\xe1lido es obligatorio para el Giro Bancario."})),"successful"===e.outcome&&e.isNewClient){var i,n,t,s,l,r,o,c,d,u;(null==(i=e.nombreFiscal)?void 0:i.trim())||a.addIssue({path:["nombreFiscal"],message:"Nombre fiscal es obligatorio."}),(null==(n=e.cif)?void 0:n.trim())?/^([A-Z]{1}|[0-9]{1})[0-9]{7}[A-Z0-9]{1}$/i.test(e.cif)||a.addIssue({path:["cif"],message:"Formato de CIF/NIF no v\xe1lido. Use 1 letra, 7 n\xfameros y 1 car\xe1cter de control."}):a.addIssue({path:["cif"],message:"CIF es obligatorio."}),(null==(t=e.direccionFiscal_street)?void 0:t.trim())||a.addIssue({path:["direccionFiscal_street"],message:"Calle es obligatoria."}),(null==(s=e.direccionFiscal_city)?void 0:s.trim())||a.addIssue({path:["direccionFiscal_city"],message:"Ciudad es obligatoria."}),(null==(l=e.direccionFiscal_province)?void 0:l.trim())||a.addIssue({path:["direccionFiscal_province"],message:"Provincia es obligatoria."}),(null==(r=e.direccionFiscal_postalCode)?void 0:r.trim())||a.addIssue({path:["direccionFiscal_postalCode"],message:"C\xf3digo postal es obligatorio."}),!e.sameAsBilling&&((null==(o=e.direccionEntrega_street)?void 0:o.trim())||a.addIssue({path:["direccionEntrega_street"],message:"Calle de entrega es obligatoria."}),(null==(c=e.direccionEntrega_city)?void 0:c.trim())||a.addIssue({path:["direccionEntrega_city"],message:"Ciudad de entrega es obligatoria."}),(null==(d=e.direccionEntrega_province)?void 0:d.trim())||a.addIssue({path:["direccionEntrega_province"],message:"Provincia de entrega es obligatoria."}),(null==(u=e.direccionEntrega_postalCode)?void 0:u.trim())||a.addIssue({path:["direccionEntrega_postalCode"],message:"C\xf3digo postal de entrega es obligatorio."}))}"follow-up"===e.outcome&&(e.nextActionType?"Opci\xf3n personalizada"!==e.nextActionType||e.nextActionCustom&&""!==e.nextActionCustom.trim()||a.addIssue({path:["nextActionCustom"],message:"Debe especificar la pr\xf3xima acci\xf3n."}):a.addIssue({path:["nextActionType"],message:"La pr\xf3xima acci\xf3n es obligatoria."})),"failed"===e.outcome&&(e.failureReasonType?"Otro (especificar)"!==e.failureReasonType||e.failureReasonCustom&&""!==e.failureReasonCustom.trim()||a.addIssue({path:["failureReasonCustom"],message:"Debe especificar el motivo del fallo."}):a.addIssue({path:["failureReasonType"],message:"El motivo del fallo es obligatorio."})),"Clavadista"!==e.userRole||"follow-up"!==e.outcome||e.clavadistaSelectedSalesRepId&&""!==e.clavadistaSelectedSalesRepId.trim()||a.addIssue({path:["clavadistaSelectedSalesRepId"],message:"Debes asignar un comercial para el seguimiento."})});var _=i(73168),A=i(62523),S=i(30285),M=i(75074),k=i(86950),B=i(34301);let P=e=>{let{searchTerm:a,setSearchTerm:i,filteredAccounts:t,handleClientSelect:s,debouncedSearchTerm:l}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(r.aR,{children:[(0,n.jsx)(r.ZB,{children:"Paso 1: \xbfA qu\xe9 cliente has visitado?"}),(0,n.jsx)(r.BT,{children:"Busca un cliente existente o introduce el nombre de uno nuevo para continuar."})]}),(0,n.jsxs)(r.Wu,{className:"space-y-4",children:[(0,n.jsxs)("div",{className:"relative",children:[(0,n.jsx)(M.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-muted-foreground"}),(0,n.jsx)(A.p,{placeholder:"Buscar por nombre o CIF...",value:a,onChange:e=>i(e.target.value),className:"pl-10"})]}),t.length>0&&(0,n.jsx)("div",{className:"space-y-2 max-h-60 overflow-y-auto p-1",children:t.map(e=>(0,n.jsxs)(S.$,{type:"button",variant:"outline",className:"w-full justify-start",onClick:()=>s(e),children:[" ",(0,n.jsx)(k.A,{className:"mr-2 h-4 w-4 text-muted-foreground"})," ",e.nombre," "]},e.id))}),l&&0===t.length&&(0,n.jsxs)("div",{className:"text-center p-4 border-dashed border-2 rounded-md",children:[(0,n.jsxs)("p",{className:"text-sm text-muted-foreground",children:['No se encontr\xf3 al cliente "',l,'".']}),(0,n.jsxs)(S.$,{type:"button",className:"mt-2",onClick:()=>s({id:"new",nombre:l}),children:[" ",(0,n.jsx)(B.A,{className:"mr-2 h-4 w-4"})," Continuar como nuevo cliente "]})]})]})]})};var T=i(12543);let V=e=>{let{form:a,client:i,setStep:t,handleBack:s}=e;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(r.aR,{children:[(0,n.jsxs)(r.ZB,{children:['Paso 2: \xbfCu\xe1l fue el resultado para "',null==i?void 0:i.nombre,'"?']}),(0,n.jsx)(r.BT,{children:"Selecciona el resultado de la interacci\xf3n para continuar."})]}),(0,n.jsxs)(r.Wu,{className:"grid grid-cols-1 gap-4",children:[(0,n.jsx)(S.$,{type:"button",variant:"outline",className:"w-full h-16 text-lg",onClick:()=>{a.setValue("outcome","successful"),t("details")},children:"Pedido Exitoso"}),(0,n.jsx)(S.$,{type:"button",variant:"outline",className:"w-full h-16 text-lg",onClick:()=>{a.setValue("outcome","follow-up"),t("details")},children:"Requiere Seguimiento"}),(0,n.jsx)(S.$,{type:"button",variant:"outline",className:"w-full h-16 text-lg",onClick:()=>{a.setValue("outcome","failed"),t("details")},children:"Visita Fallida / Sin Pedido"})]}),(0,n.jsx)(r.wL,{children:(0,n.jsxs)(S.$,{type:"button",variant:"ghost",onClick:s,children:[(0,n.jsx)(T.A,{className:"mr-2 h-4 w-4"})," Volver"]})})]})};var D=i(59409),O=i(14636),z=i(85511),J=i(22346),q=i(88539),U=i(47262),Y=i(50594),L=i(51920),H=i(91467),Z=i(77223),$=i(19968),G=i(78816),W=i(82083),Q=i(61055),X=i(59434);let K=e=>{let{form:a,handleBack:i,handleNextStep:s,availableMaterials:l,materialFields:c,appendMaterial:d,removeMaterial:m,userRole:x,salesRepsList:p,clavadistas:h}=e,j=(0,u.FH)({control:a.control,name:"outcome"}),v=(0,u.FH)({control:a.control,name:"paymentMethod"}),f=(0,u.FH)({control:a.control,name:"nextActionType"}),g=(0,u.FH)({control:a.control,name:"failureReasonType"}),b=(0,u.FH)({control:a.control,name:"assignedMaterials"}),y=(0,u.FH)({control:a.control,name:"isNewClient"}),C=(0,u.FH)({control:a.control,name:"sameAsBilling"});return t.useEffect(()=>{b&&b.forEach((e,i)=>{if(!e.quantity||!e.materialId)return;let n=l.find(a=>a.id===e.materialId);n&&n.stock<e.quantity?a.setError("assignedMaterials.".concat(i,".quantity"),{type:"manual",message:"Stock: ".concat(n.stock,". Pides: ").concat(e.quantity,".")}):a.clearErrors("assignedMaterials.".concat(i,".quantity"))})},[b,l,a]),(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(r.aR,{children:(0,n.jsx)(r.ZB,{children:"Paso 3: Completa los Detalles"})}),(0,n.jsxs)(r.Wu,{className:"space-y-6",children:[(0,n.jsxs)("div",{className:"space-y-4",children:[(0,n.jsx)("h3",{className:"text-md font-semibold text-primary",children:"Detalles del Pedido"}),(0,n.jsxs)("div",{className:"text-sm text-muted-foreground flex items-start gap-2 p-3 bg-secondary/30 rounded-lg",children:[(0,n.jsx)(Y.A,{className:"h-4 w-4 mt-0.5 flex-shrink-0"}),(0,n.jsxs)("p",{children:["Si la visita result\xf3 en un ",(0,n.jsx)("strong",{className:"text-foreground",children:"pedido exitoso"}),", estos campos son obligatorios. Para ",(0,n.jsx)("strong",{className:"text-foreground",children:"seguimientos"})," o ",(0,n.jsx)("strong",{className:"text-foreground",children:"visitas fallidas"}),", son opcionales."]})]}),(0,n.jsx)(o.zB,{control:a.control,name:"numberOfUnits",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"N\xfamero de Unidades"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{type:"number",min:1,step:1,placeholder:"Ej: 12",...i,value:null!=(a=i.value)?a:"",onChange:e=>i.onChange(""===e.target.value?void 0:parseInt(e.target.value,10))})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"unitPrice",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Precio Unitario (€ sin IVA)"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{type:"number",min:.01,step:.01,placeholder:"Ej: 15.50",...i,value:null!=(a=i.value)?a:"",onChange:e=>i.onChange(""===e.target.value?void 0:parseFloat(e.target.value))})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"paymentMethod",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Forma de Pago"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar forma de pago"})})}),(0,n.jsx)(D.gC,{children:I.IJ.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}}),"Giro Bancario"===v&&(0,n.jsx)(o.zB,{control:a.control,name:"iban",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"IBAN"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{placeholder:"ES00 0000 0000 0000 0000 0000",...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}})]}),"follow-up"===j&&(0,n.jsxs)("div",{className:"space-y-4 pt-4 border-t",children:[(0,n.jsx)("h3",{className:"text-md font-semibold text-primary",children:"Pr\xf3xima Tarea de Seguimiento"}),(0,n.jsx)(o.zB,{control:a.control,name:"nextActionType",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Pr\xf3xima Acci\xf3n"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar pr\xf3xima acci\xf3n..."})})}),(0,n.jsx)(D.gC,{children:I.Cv.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}}),"Opci\xf3n personalizada"===f&&(0,n.jsx)(o.zB,{control:a.control,name:"nextActionCustom",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Especificar Acci\xf3n"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...a})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"nextActionDate",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{className:"flex flex-col",children:[(0,n.jsx)(o.lR,{children:"Fecha Pr\xf3xima Acci\xf3n (Opcional)"}),(0,n.jsxs)(O.AM,{children:[(0,n.jsx)(O.Wv,{asChild:!0,children:(0,n.jsx)(o.MJ,{children:(0,n.jsxs)(S.$,{type:"button",variant:"outline",className:(0,X.cn)("w-full justify-start text-left font-normal",!a.value&&"text-muted-foreground"),"aria-label":"Abrir calendario para seleccionar fecha de pr\xf3xima acci\xf3n",children:[(0,n.jsx)(L.A,{className:"mr-2 h-4 w-4"}),(0,n.jsx)("span",{children:a.value?(0,_.GP)(a.value,"PPP",{locale:Q.es}):"Seleccione fecha"})]})})}),(0,n.jsx)(O.hl,{className:"w-auto p-0",align:"start",children:(0,n.jsx)(z.V,{mode:"single",selected:a.value,onSelect:a.onChange,disabled:e=>e<(0,G.e)(new Date,1)&&!(0,W.n)(e,(0,G.e)(new Date,1)),initialFocus:!0,locale:Q.es})})]}),(0,n.jsx)(o.C5,{})]})}}),("Admin"===x||"Clavadista"===x)&&"follow-up"===j&&(0,n.jsx)(o.zB,{control:a.control,name:"Admin"===x?"selectedSalesRepId":"clavadistaSelectedSalesRepId",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Asignar Seguimiento a:"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar comercial..."})})}),(0,n.jsxs)(D.gC,{children:["Admin"===x&&(0,n.jsx)(D.eb,{value:w,children:"Yo mismo/a (Admin)"}),p.map(e=>(0,n.jsx)(D.eb,{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)(o.C5,{})]})}})]}),"failed"===j&&(0,n.jsxs)("div",{className:"space-y-4 pt-4 border-t",children:[(0,n.jsx)("h3",{className:"text-md font-semibold text-primary",children:"Detalles del Fallo"}),(0,n.jsx)(o.zB,{control:a.control,name:"failureReasonType",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Motivo del Fallo"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar motivo..."})})}),(0,n.jsx)(D.gC,{children:I.HF.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}}),"Otro (especificar)"===g&&(0,n.jsx)(o.zB,{control:a.control,name:"failureReasonCustom",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Especificar Motivo"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...a})}),(0,n.jsx)(o.C5,{})]})}})]}),y&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(J.w,{className:"!mt-8"}),(0,n.jsx)("h3",{className:"text-lg font-semibold text-primary",children:"Informaci\xf3n de la Nueva Cuenta"}),(0,n.jsx)("p",{className:"text-sm text-muted-foreground",children:"Completa los datos de facturaci\xf3n y entrega. Son obligatorios si el resultado fue un pedido exitoso."}),(0,n.jsx)(J.w,{}),(0,n.jsx)("h3",{className:"font-semibold text-base mt-2",children:"Datos de Facturaci\xf3n"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsx)(o.zB,{control:a.control,name:"nombreFiscal",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Nombre Fiscal"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"cif",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"CIF"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}})]}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionFiscal_street",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Calle Fiscal"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[(0,n.jsx)(o.zB,{control:a.control,name:"direccionFiscal_number",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"N\xfamero"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionFiscal_postalCode",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"C.P."}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionFiscal_city",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Ciudad"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionFiscal_province",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Provincia"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar provincia"})})}),(0,n.jsx)(D.gC,{children:I.tF.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}})]}),(0,n.jsx)(J.w,{}),(0,n.jsx)("h3",{className:"font-semibold text-base mt-2",children:"Datos de Entrega"}),(0,n.jsx)(o.zB,{control:a.control,name:"sameAsBilling",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{className:"flex flex-row items-center space-x-2 space-y-0",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(U.S,{checked:a.value,onCheckedChange:a.onChange})}),(0,n.jsx)(o.lR,{className:"font-normal",children:"La direcci\xf3n de entrega es la misma que la de facturaci\xf3n"})]})}}),!C&&(0,n.jsxs)("div",{className:"space-y-4 pt-2 border-l-2 pl-4 border-primary",children:[(0,n.jsx)(o.zB,{control:a.control,name:"direccionEntrega_street",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Calle Entrega"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-2",children:[(0,n.jsx)(o.zB,{control:a.control,name:"direccionEntrega_number",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"N\xfamero"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionEntrega_postalCode",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"C.P."}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionEntrega_city",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Ciudad"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"direccionEntrega_province",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Provincia"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar provincia"})})}),(0,n.jsx)(D.gC,{children:I.tF.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}})]})]}),(0,n.jsx)(J.w,{}),(0,n.jsx)("h3",{className:"font-semibold text-base mt-2",children:"Datos de Contacto (Opcional)"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsx)(o.zB,{control:a.control,name:"contactoNombre",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Nombre Contacto"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"contactoTelefono",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Tel\xe9fono Contacto"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}})]}),(0,n.jsx)(o.zB,{control:a.control,name:"contactoCorreo",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Email Contacto"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{...i,value:null!=(a=i.value)?a:""})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"observacionesAlta",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Observaciones sobre el Alta"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(q.T,{placeholder:"Ej: Condiciones especiales acordadas...",...a})}),(0,n.jsx)(o.C5,{})]})}})]}),(0,n.jsx)(J.w,{className:"!mt-8"}),(0,n.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,n.jsx)(o.zB,{control:a.control,name:"canalOrigenColocacion",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Canal Origen Colocaci\xf3n"}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:"",children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar canal de origen"})})}),(0,n.jsx)(D.gC,{children:I.QZ.map(e=>(0,n.jsx)(D.eb,{value:e,children:e},e))})]}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"clavadistaId",render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsxs)(o.lR,{className:"flex items-center",children:[(0,n.jsx)(H.A,{className:"mr-2 h-4 w-4 text-primary"}),"Clavadista (Brand Ambassador)"]}),(0,n.jsxs)(D.l6,{onValueChange:i.onChange,value:null!=(a=i.value)?a:F,disabled:"Clavadista"===x,children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar clavadista..."})})}),(0,n.jsxs)(D.gC,{children:[(0,n.jsx)(D.eb,{value:F,children:"Ninguno"}),h.map(e=>(0,n.jsx)(D.eb,{value:e.id,children:e.name},e.id))]})]}),(0,n.jsx)(o.Rr,{children:"Si un Brand Ambassador particip\xf3 en la visita, selecci\xf3nalo aqu\xed."}),(0,n.jsx)(o.C5,{})]})}})]}),(0,n.jsx)(o.zB,{control:a.control,name:"notes",render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{children:"Notas Adicionales (Opcional)"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(q.T,{placeholder:"A\xf1ade cualquier comentario sobre esta interacci\xf3n...",...a})}),(0,n.jsx)(o.Rr,{children:"Estas notas se guardar\xe1n con el registro de la interacci\xf3n."}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(J.w,{className:"!mt-8"}),(0,n.jsxs)("div",{className:"space-y-2",children:[(0,n.jsx)("h3",{className:"text-base font-semibold",children:"Material Promocional"}),(0,n.jsx)(o.Rr,{children:"A\xf1ade los materiales que se han entregado durante esta interacci\xf3n (Opcional)."}),c.map((e,i)=>(0,n.jsx)("div",{className:"p-3 border rounded-md bg-muted/50",children:(0,n.jsxs)("div",{className:"flex items-end gap-2",children:[(0,n.jsx)(o.zB,{control:a.control,name:"assignedMaterials.".concat(i,".materialId"),render:e=>{let{field:a}=e;return(0,n.jsxs)(o.eI,{className:"flex-grow",children:[(0,n.jsx)(o.lR,{className:"text-xs",children:"Material"}),(0,n.jsxs)(D.l6,{onValueChange:a.onChange,value:a.value,children:[(0,n.jsx)(o.MJ,{children:(0,n.jsx)(D.bq,{children:(0,n.jsx)(D.yv,{placeholder:"Seleccionar material..."})})}),(0,n.jsx)(D.gC,{children:l.map(e=>(0,n.jsxs)(D.eb,{value:e.id,children:[e.name," (Stock: ",e.stock,")"]},e.id))})]}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(o.zB,{control:a.control,name:"assignedMaterials.".concat(i,".quantity"),render:e=>{var a;let{field:i}=e;return(0,n.jsxs)(o.eI,{children:[(0,n.jsx)(o.lR,{className:"text-xs",children:"Cantidad"}),(0,n.jsx)(o.MJ,{children:(0,n.jsx)(A.p,{type:"number",min:1,step:1,placeholder:"Cant.",className:"w-24",...i,value:null!=(a=i.value)?a:"",onChange:e=>i.onChange(""===e.target.value?void 0:parseInt(e.target.value,10))})}),(0,n.jsx)(o.C5,{})]})}}),(0,n.jsx)(S.$,{type:"button",variant:"destructive",size:"icon",onClick:()=>m(i),children:(0,n.jsx)(Z.A,{className:"h-4 w-4"})})]})},e.id)),(0,n.jsx)("div",{className:"pt-2",children:(0,n.jsxs)(S.$,{type:"button",variant:"outline",size:"sm",onClick:()=>d({materialId:"",quantity:void 0}),children:[(0,n.jsx)(B.A,{className:"mr-2 h-4 w-4"})," A\xf1adir Material"]})})]})]}),(0,n.jsxs)(r.wL,{className:"flex justify-between",children:[(0,n.jsxs)(S.$,{type:"button",variant:"ghost",onClick:i,children:[(0,n.jsx)(T.A,{className:"mr-2 h-4 w-4"})," Volver"]}),(0,n.jsxs)(S.$,{type:"button",onClick:s,children:["Continuar ",(0,n.jsx)($.A,{className:"ml-2 h-4 w-4"})]})]})]})};var ee=i(73672),ea=i(61930);let ei=e=>{var a;let{form:i,client:t,handleBack:s,availableMaterials:l,teamMember:o,userRole:d}=e,u=i.watch(),m="successful"===u.outcome,x="follow-up"===u.outcome,p=(u.numberOfUnits||0)*(u.unitPrice||0),h=!i.formState.isSubmitting&&!!o&&!!d;return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)(r.aR,{children:[(0,n.jsx)(r.ZB,{children:"Paso Final: Verifica y Confirma"}),(0,n.jsx)(r.BT,{children:"Revisa los datos antes de guardar."})]}),(0,n.jsxs)(r.Wu,{className:"space-y-6",children:[(0,n.jsxs)(r.Zp,{children:[(0,n.jsx)(r.aR,{children:(0,n.jsx)(r.ZB,{className:"text-lg",children:"Resumen de la Interacci\xf3n"})}),(0,n.jsxs)(r.Wu,{className:"space-y-2 text-sm",children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Cliente:"})," ",null==t?void 0:t.nombre,(null==t?void 0:t.id)==="new"&&(0,n.jsxs)(n.Fragment,{children:[" ",(0,n.jsx)("span",{className:"text-primary font-bold",children:"(Nuevo)"})]})]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Resultado:"})," ",(0,n.jsx)("span",{className:"font-semibold",children:m?"Pedido Exitoso":x?"Requiere Seguimiento":"Visita Fallida"})]}),m&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Unidades:"})," ",u.numberOfUnits]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Forma de Pago:"})," ",u.paymentMethod,"Giro Bancario"===u.paymentMethod&&" – ".concat(u.iban)]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Valor Total (IVA incl.):"})," ",(0,n.jsx)(ea.A,{value:1.21*p,options:{style:"currency",currency:"EUR"}})]})]}),x&&(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Pr\xf3xima Acci\xf3n:"})," ",u.nextActionType]}),"failed"===u.outcome&&(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Motivo:"})," ",u.failureReasonType]}),u.notes&&(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Notas:"})," ",u.notes]}),(null==(a=u.assignedMaterials)?void 0:a.length)>0&&(0,n.jsxs)("div",{children:[(0,n.jsx)("strong",{children:"Materiales Entregados:"}),(0,n.jsx)("ul",{className:"list-disc pl-5 mt-1",children:u.assignedMaterials.map((e,a)=>{var i;let t=l.find(a=>a.id===e.materialId);return(0,n.jsxs)("li",{children:[null!=(i=null==t?void 0:t.name)?i:"Material"," – ",e.quantity]},a)})})]})]})]}),u.isNewClient&&(0,n.jsxs)(r.Zp,{children:[(0,n.jsx)(r.aR,{children:(0,n.jsx)(r.ZB,{className:"text-lg",children:"Datos de la Nueva Cuenta"})}),(0,n.jsxs)(r.Wu,{className:"space-y-2 text-sm",children:[(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Nombre Fiscal:"})," ",u.nombreFiscal||"No especificado"]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"CIF:"})," ",u.cif||"No especificado"]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Direcci\xf3n Fiscal:"})," ",u.direccionFiscal_street?"".concat(u.direccionFiscal_street,", ").concat(u.direccionFiscal_city):"No especificada"]}),(0,n.jsxs)("p",{children:[(0,n.jsx)("strong",{children:"Direcci\xf3n Entrega:"})," ",u.sameAsBilling?"(Misma que facturaci\xf3n)":u.direccionEntrega_street?"".concat(u.direccionEntrega_street,", ").concat(u.direccionEntrega_city):"No especificada"]})]})]})]}),(0,n.jsxs)(r.wL,{className:"flex justify-between",children:[(0,n.jsxs)(S.$,{type:"button",variant:"ghost",onClick:s,disabled:i.formState.isSubmitting,children:[(0,n.jsx)(T.A,{className:"mr-2 h-4 w-4"})," Volver"]}),(0,n.jsx)(S.$,{type:"submit",disabled:!h,children:i.formState.isSubmitting?(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(c.A,{className:"mr-2 h-4 w-4 animate-spin"})," Guardando…"]}):(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(ee.A,{className:"mr-2 h-4 w-4"})," Confirmar y Guardar"]})})]})]})};function en(){let e=function(){let{toast:e}=(0,x.dj)(),a=(0,p.useRouter)(),i=(0,p.useSearchParams)(),{teamMember:n,userRole:s,refreshDataSignature:l}=(0,h.A)(),[r,o]=t.useState("client"),[c,d]=t.useState(null),[g,N]=t.useState(!0),[I,R]=t.useState([]),[A,S]=t.useState([]),[M,k]=t.useState([]),[B,P]=t.useState([]),[T,V]=t.useState(null),[D,O]=t.useState(""),[z,J]=t.useState("");t.useEffect(()=>{let e=setTimeout(()=>{J(D)},300);return()=>{clearTimeout(e)}},[D]);let q=t.useMemo(()=>z?I.filter(e=>e.nombre.toLowerCase().includes(z.toLowerCase())||e.cif&&e.cif.toLowerCase().includes(z.toLowerCase())):[],[z,I]),U=(0,u.mN)({resolver:(0,m.u)(E),mode:"onBlur",defaultValues:{userRole:null,isNewClient:!1,outcome:void 0,clavadistaId:F,selectedSalesRepId:"",clavadistaSelectedSalesRepId:"",canalOrigenColocacion:void 0,paymentMethod:"Adelantado",iban:"",clientType:void 0,numberOfUnits:void 0,unitPrice:void 0,nombreFiscal:"",cif:"",direccionFiscal_street:"",direccionFiscal_number:"",direccionFiscal_city:"",direccionFiscal_province:"",direccionFiscal_postalCode:"",direccionFiscal_country:"Espa\xf1a",sameAsBilling:!0,direccionEntrega_street:"",direccionEntrega_number:"",direccionEntrega_city:"",direccionEntrega_province:"",direccionEntrega_postalCode:"",direccionEntrega_country:"Espa\xf1a",contactoNombre:"",contactoCorreo:"",contactoTelefono:"",observacionesAlta:"",nextActionType:void 0,nextActionCustom:"",nextActionDate:void 0,failureReasonType:void 0,failureReasonCustom:"",notes:"",assignedMaterials:[]}}),{trigger:Y}=U,L=U.watch("cif");t.useEffect(()=>{(async()=>{if(L&&L.length>5){let e=I.find(e=>e.cif&&e.cif.toLowerCase()===L.toLowerCase());if(e){let a=M.find(a=>a.id===e.salesRepId),i=a?a.name:"un administrador";U.setError("cif",{type:"manual",message:"Este CIF ya est\xe1 registrado y pertenece a ".concat(i,".")})}else U.clearErrors("cif")}})()},[L,I,U,M]),t.useEffect(()=>{s&&U.reset({...U.getValues(),userRole:s,clavadistaId:"Clavadista"===s&&n?n.id:U.getValues("clavadistaId")})},[s,n,U]);let{fields:H,append:Z,remove:$}=(0,u.jz)({control:U.control,name:"assignedMaterials"}),G=U.watch("sameAsBilling"),W=U.watch("direccionFiscal_street"),Q=U.watch("direccionFiscal_number"),X=U.watch("direccionFiscal_city"),K=U.watch("direccionFiscal_province"),ee=U.watch("direccionFiscal_postalCode"),ea=U.watch("direccionFiscal_country");t.useEffect(()=>{G?(U.setValue("direccionEntrega_street",W),U.setValue("direccionEntrega_number",Q),U.setValue("direccionEntrega_city",X),U.setValue("direccionEntrega_province",K),U.setValue("direccionEntrega_postalCode",ee),U.setValue("direccionEntrega_country",ea)):!1===U.getValues("sameAsBilling")&&(U.setValue("direccionEntrega_street",""),U.setValue("direccionEntrega_number",""),U.setValue("direccionEntrega_city",""),U.setValue("direccionEntrega_province",""),U.setValue("direccionEntrega_postalCode",""),U.setValue("direccionEntrega_country","Espa\xf1a"))},[G,W,Q,X,K,ee,ea,U]);let ei=t.useCallback(a=>{if(!s||!n)return void e({title:"Error",description:"No se pudo identificar al usuario actual.",variant:"destructive"});if("new"!==a.id){let i=!1;if("Admin"===s)i=!0;else if("SalesRep"===s)i=a.salesRepId===n.id;else if("Clavadista"===s){let e=[...M,...A].find(e=>e.id===a.salesRepId||e.id===a.embajadorId);i=(null==e?void 0:e.id)===n.id}if(!i){let i=[...M,...A].find(e=>e.id===a.salesRepId||e.id===a.embajadorId),n=(null==i?void 0:i.name)||"otro miembro del equipo";e({title:"Acceso Denegado a la Cuenta",description:'Esta cuenta ya est\xe1 abierta. Contacta con "'.concat(n,'" para m\xe1s informaci\xf3n.'),variant:"destructive",duration:7e3});return}}d(a),U.setValue("isNewClient","new"===a.id),"new"===a.id?U.setValue("clientType","HORECA"):(U.setValue("clientType",a.type),U.setValue("iban",a.iban)),o("outcome")},[U,s,n,e,M,A]);t.useEffect(()=>{!async function(){N(!0);let a=i.get("originatingTaskId"),n=i.get("accountId");try{let[e,i,t,s,l]=await Promise.all([(0,j.U)(),(0,v.I)(["Clavadista","L\xedder Clavadista"]),(0,v.I)(["SalesRep","Admin"]),(0,f.y)(),a?b(a):Promise.resolve(null)]);if(R(e),S(i),k(t),P(s),l){V(l);let a=e.find(e=>e.id===l.accountId||e.nombre===l.clientName);a&&ei(a)}else if(n){let a=e.find(e=>e.id===n);a&&ei(a)}}catch(a){e({title:"Error",description:"No se pudieron cargar los datos necesarios.",variant:"destructive"})}finally{N(!1)}}()},[i,e]);let en=async()=>{let e=[];if("details"===r){let a=U.getValues("outcome");"successful"===a?e=["numberOfUnits","unitPrice","paymentMethod","iban"]:"follow-up"===a?e=["nextActionType","nextActionCustom","nextActionDate","selectedSalesRepId","clavadistaSelectedSalesRepId"]:"failed"===a&&(e=["failureReasonType","failureReasonCustom"]),e.push("assignedMaterials"),U.getValues("isNewClient")&&"successful"===a&&(e.push("nombreFiscal","cif","direccionFiscal_street","direccionFiscal_city","direccionFiscal_province","direccionFiscal_postalCode"),U.getValues("sameAsBilling")||e.push("direccionEntrega_street","direccionEntrega_city","direccionEntrega_province","direccionEntrega_postalCode"))}(!(e.length>0)||await U.trigger(e))&&"details"===r&&o("verify")},et=async i=>{if(!n||!s)return void e({title:"Error de autenticaci\xf3n",description:"No se pudo identificar al usuario. Por favor, recargue la p\xe1gina.",variant:"destructive"});if(!c){e({title:"Error de Cliente",description:"No se ha seleccionado un cliente v\xe1lido. Por favor, vuelve al primer paso.",variant:"destructive"}),o("client");return}try{await (0,y.c4)(C.db,async e=>{let a=n.name,t=n.id,l=null;if(("L\xedder Clavadista"===s||"Clavadista"===s)&&(l=n.id),"Admin"===s&&i.selectedSalesRepId&&i.selectedSalesRepId!==w){let e=M.find(e=>e.id===i.selectedSalesRepId);e&&(a=e.name,t=e.id)}else if("Clavadista"===s&&"follow-up"===i.outcome){let e=M.find(e=>e.id===i.clavadistaSelectedSalesRepId);if(e)a=e.name,t=e.id;else throw Error("Un Clavadista debe asignar un comercial para un seguimiento.")}let r=(null==c?void 0:c.id)!=="new"&&(null==c?void 0:c.id)||null;if((null==c?void 0:c.id)==="new"){if(i.cif){let e=I.find(e=>e.cif&&e.cif.toLowerCase()===i.cif.toLowerCase());if(e){let a=M.find(a=>a.id===e.salesRepId);throw Error("El CIF ".concat(i.cif," ya pertenece a ").concat(a?a.name:"otro usuario","."))}}let a=(0,y.H9)((0,y.rJ)(C.db,"accounts"));r=a.id;let n="successful"===i.outcome,s={id:r,nombre:c.nombre,legalName:n&&i.nombreFiscal||void 0,cif:n&&i.cif||"",type:n&&i.clientType||"Otro",potencial:"medio",addressBilling:n&&i.direccionFiscal_street?{street:i.direccionFiscal_street||null,number:i.direccionFiscal_number||null,city:i.direccionFiscal_city||null,province:i.direccionFiscal_province||null,postalCode:i.direccionFiscal_postalCode||null,country:i.direccionFiscal_country||"Espa\xf1a"}:void 0,addressShipping:n?i.sameAsBilling&&i.direccionFiscal_street?{street:i.direccionFiscal_street||null,number:i.direccionFiscal_number||null,city:i.direccionFiscal_city||null,province:i.direccionFiscal_province||null,postalCode:i.direccionFiscal_postalCode||null,country:i.direccionFiscal_country||"Espa\xf1a"}:i.direccionEntrega_street?{street:i.direccionEntrega_street||null,number:i.direccionEntrega_number||null,city:i.direccionEntrega_city||null,province:i.direccionEntrega_province||null,postalCode:i.direccionEntrega_postalCode||null,country:i.direccionEntrega_country||"Espa\xf1a"}:void 0:void 0,mainContactName:n&&i.contactoNombre||void 0,mainContactEmail:n&&i.contactoCorreo||void 0,mainContactPhone:n&&i.contactoTelefono||void 0,notes:n?i.observacionesAlta||void 0:"Cuenta creada autom\xe1ticamente desde una interacci\xf3n inicial.",salesRepId:t,responsableId:t,iban:n&&i.iban||void 0,createdAt:new Date().toISOString(),updatedAt:new Date().toISOString(),ciudad:i.direccionFiscal_city||i.direccionEntrega_city||void 0,embajadorId:l};e.set(a,JSON.parse(JSON.stringify(s,(e,a)=>void 0===a?null:a)))}else if((null==c?void 0:c.id)&&"successful"===i.outcome&&i.iban){let a=I.find(e=>e.id===c.id);a&&!a.iban&&e.update((0,y.H9)(C.db,"accounts",c.id),{iban:i.iban,updatedAt:y.Dc.fromDate(new Date)})}let o=(i.numberOfUnits||0)*(i.unitPrice||0),d=.21*o,u=(0,y.H9)((0,y.rJ)(C.db,"orders")),m="successful"===i.outcome||"failed"===i.outcome,x="Pendiente";"successful"===i.outcome?x="Confirmado":"follow-up"===i.outcome?x="Seguimiento":"failed"===i.outcome&&(x="Fallido");let p={clientName:c.nombre,accountId:r,visitDate:m?y.Dc.fromDate(new Date):null,createdAt:y.Dc.fromDate(new Date),lastUpdated:y.Dc.fromDate(new Date),salesRep:a,status:x,clavadistaId:i.clavadistaId===F?null:i.clavadistaId||null,clientStatus:"new"===c.id?"new":"existing",originatingTaskId:(null==T?void 0:T.id)||null,canalOrigenColocacion:i.canalOrigenColocacion||null,assignedMaterials:i.assignedMaterials||[],notes:i.notes||null,products:"successful"===i.outcome?["Santa Brisa 750ml"]:[],numberOfUnits:"successful"===i.outcome&&i.numberOfUnits||null,unitPrice:"successful"===i.outcome&&i.unitPrice||null,value:"successful"===i.outcome?o+d:null,clientType:"successful"===i.outcome&&i.clientType||null,paymentMethod:"successful"===i.outcome&&i.paymentMethod||null,iban:"successful"===i.outcome&&i.iban||null,nextActionType:"follow-up"===i.outcome&&i.nextActionType||null,nextActionCustom:"follow-up"===i.outcome&&"Opci\xf3n personalizada"===i.nextActionType&&i.nextActionCustom||null,nextActionDate:"follow-up"===i.outcome&&i.nextActionDate?y.Dc.fromDate(i.nextActionDate):null,failureReasonType:"failed"===i.outcome&&i.failureReasonType||null,failureReasonCustom:"failed"===i.outcome&&"Otro (especificar)"===i.failureReasonType&&i.failureReasonCustom||null,embajadorId:l};for(let e in p)void 0===p[e]&&(p[e]=null);if(e.set(u,p),T&&e.update((0,y.H9)(C.db,"orders",T.id),{status:"Completado",lastUpdated:y.Dc.fromDate(new Date)}),i.assignedMaterials&&i.assignedMaterials.length>0){for(let a of i.assignedMaterials)if(a.materialId&&a.quantity){let i=(0,y.H9)(C.db,"inventoryItems",a.materialId),n=await e.get(i);if(n.exists()){var h;let t=null!=(h=n.data().stock)?h:0;e.update(i,{stock:t-a.quantity})}}}if("Confirmado"===x){let n=(0,y.H9)((0,y.rJ)(C.db,"mail")),t="\n                    <p>\xa1Hola!</p>\n                    <p>Se ha registrado un nuevo pedido para <strong>".concat(c.nombre,"</strong>.</p>\n                    <ul>\n                        <li><strong>Fecha:</strong> ").concat((0,_.GP)(new Date,"dd/MM/yyyy HH:mm"),"</li>\n                        <li><strong>Comercial:</strong> ").concat(a,"</li>\n                        <li><strong>Unidades:</strong> ").concat(i.numberOfUnits,"</li>\n                        <li><strong>Valor:</strong> ").concat(new Intl.NumberFormat("es-ES",{style:"currency",currency:"EUR"}).format(o+d),"</li>\n                    </ul>\n                    <p>Por favor, accede al CRM para ver todos los detalles y gestionar el pedido.</p>\n                    <p>Gracias,</p>\n                    <p>El equipo de Santa Brisa</p>\n                "),s={to:["distribucion@example.com"],message:{subject:"Nuevo Pedido Registrado: ".concat(c.nombre),html:t}};e.set(n,s)}}),e({title:"\xa1Interacci\xf3n Registrada!",description:"Se ha guardado el resultado para ".concat(c.nombre,".")}),l(),"successful"===i.outcome?a.push("/orders-dashboard"):a.push("/accounts")}catch(a){console.error("Error en la transacci\xf3n del formulario:",a,"Datos del formulario:",JSON.stringify(i,null,2)),e({title:"Error Cr\xedtico al Guardar",description:"No se pudo registrar la interacci\xf3n. Por favor, contacta con soporte. Error: ".concat(a.message),variant:"destructive",duration:1e4})}};return{form:U,step:r,setStep:o,client:c,handleClientSelect:ei,searchTerm:D,setSearchTerm:O,filteredAccounts:q,debouncedSearchTerm:z,handleBack:()=>{"outcome"===r&&o("client"),"details"===r&&o("outcome"),"verify"===r&&o("details")},handleNextStep:en,onSubmit:et,onFormError:a=>{console.warn("Validation Errors:",a);let i=U.getValues(),n=[];if("successful"===i.outcome&&((!i.numberOfUnits||i.numberOfUnits<=0)&&n.push("Unidades"),(!i.unitPrice||i.unitPrice<=0)&&n.push("Precio Unitario"),i.paymentMethod||n.push("Forma de Pago"),i.isNewClient)){var t,s,l;(null==(t=i.nombreFiscal)?void 0:t.trim())||n.push("Nombre Fiscal"),(null==(s=i.cif)?void 0:s.trim())||n.push("CIF"),(null==(l=i.direccionFiscal_street)?void 0:l.trim())||n.push("Direcci\xf3n Fiscal")}"follow-up"!==i.outcome||i.nextActionType||n.push("Pr\xf3xima Acci\xf3n"),"failed"!==i.outcome||i.failureReasonType||n.push("Motivo del Fallo"),"Clavadista"!==i.userRole||"follow-up"!==i.outcome||i.clavadistaSelectedSalesRepId||n.push("Asignaci\xf3n de Comercial para el seguimiento");let r=Object.entries(a).map(e=>{let[a,i]=e;return"".concat(a,": ").concat(i.message)}),o="";e({title:"Errores en el formulario",description:n.length>0?"Por favor, complete los siguientes campos: ".concat(n.join(", "),"."):r.length>0?"Por favor, revise estos errores: ".concat(r.join("; ")):"Por favor, revise el formulario. Faltan campos obligatorios.",variant:"destructive",duration:9e3})},isLoading:g,clavadistas:A,salesRepsList:M,availableMaterials:B,materialFields:H,appendMaterial:Z,removeMaterial:$,userRole:s,teamMember:n}}(),{form:a,step:i,client:g,handleBack:N,availableMaterials:I,teamMember:R,userRole:A,onSubmit:S,onFormError:M,salesRepsList:k,clavadistas:B,materialFields:T,appendMaterial:D,removeMaterial:O,debouncedSearchTerm:z,searchTerm:J,setSearchTerm:q,filteredAccounts:U,handleClientSelect:Y,setStep:L,isLoading:H}=e;return H?(0,n.jsxs)("div",{className:"flex flex-col items-center justify-center h-full p-8",children:[(0,n.jsx)(c.A,{className:"h-12 w-12 animate-spin text-primary"}),(0,n.jsx)("p",{className:"mt-4 text-muted-foreground",children:"Cargando datos para el formulario..."})]}):(0,n.jsxs)("div",{className:"space-y-6",children:[(0,n.jsxs)("header",{className:"flex items-center space-x-2",children:[(0,n.jsx)(d.A,{className:"h-8 w-8 text-primary"}),(0,n.jsx)("h1",{className:"text-3xl font-headline font-semibold",children:"Registrar Interacci\xf3n"})]}),(0,n.jsx)(o.lV,{...a,children:(0,n.jsx)("form",{onSubmit:a.handleSubmit(S,M),noValidate:!0,children:(0,n.jsx)(r.Zp,{className:"max-w-4xl mx-auto shadow-lg mt-6 overflow-hidden",children:(0,n.jsx)(l.N,{mode:"wait",children:(()=>{switch(i){case"client":return(0,n.jsx)(s.P.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:(0,n.jsx)(P,{searchTerm:J,setSearchTerm:q,filteredAccounts:U,handleClientSelect:Y,debouncedSearchTerm:z})},"client");case"outcome":return(0,n.jsx)(s.P.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:(0,n.jsx)(V,{form:a,client:g,setStep:L,handleBack:N})},"outcome");case"details":return(0,n.jsx)(s.P.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:(0,n.jsx)(K,{form:a,handleBack:N,handleNextStep:e.handleNextStep,availableMaterials:I,materialFields:T,appendMaterial:D,removeMaterial:O,userRole:A,salesRepsList:k,clavadistas:B})},"details");case"verify":return(0,n.jsx)(s.P.div,{initial:{opacity:0,x:-50},animate:{opacity:1,x:0},exit:{opacity:0,x:50},children:(0,n.jsx)(ei,{form:a,client:g,handleBack:N,isSubmitting:a.formState.isSubmitting,availableMaterials:I,teamMember:R,userRole:A})},"verify")}})()})})})})]})}},46908:(e,a,i)=>{Promise.resolve().then(i.bind(i,40020))},47262:(e,a,i)=>{"use strict";i.d(a,{S:()=>o});var n=i(95155),t=i(12115),s=i(76981),l=i(10518),r=i(59434);let o=t.forwardRef((e,a)=>{let{className:i,...t}=e;return(0,n.jsx)(s.bL,{ref:a,className:(0,r.cn)("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground",i),...t,children:(0,n.jsx)(s.C1,{className:(0,r.cn)("flex items-center justify-center text-current"),children:(0,n.jsx)(l.A,{className:"h-4 w-4"})})})});o.displayName=s.bL.displayName},50594:(e,a,i)=>{"use strict";i.d(a,{A:()=>n});let n=(0,i(40157).A)("Info",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]])},61930:(e,a,i)=>{"use strict";i.d(a,{A:()=>s});var n=i(95155),t=i(12115);let s=e=>{let{value:a,options:i,locale:s="en-US",placeholder:l="N/D"}=e,[r,o]=(0,t.useState)(!1);if((0,t.useEffect)(()=>{o(!0)},[]),"number"!=typeof a||isNaN(a))return(0,n.jsx)(n.Fragment,{children:l});if(!r){let e=2*(a%1!=0);return(0,n.jsx)(n.Fragment,{children:a.toFixed(e)})}return(0,n.jsx)(n.Fragment,{children:a.toLocaleString(s,i)})}},73158:(e,a,i)=>{"use strict";i.d(a,{A:()=>n});let n=(0,i(40157).A)("ChevronRight",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]])},76981:(e,a,i)=>{"use strict";i.d(a,{C1:()=>N,bL:()=>y});var n=i(12115),t=i(6101),s=i(46081),l=i(85185),r=i(5845),o=i(45503),c=i(11275),d=i(28905),u=i(63655),m=i(95155),x="Checkbox",[p,h]=(0,s.A)(x),[j,v]=p(x);function f(e){let{__scopeCheckbox:a,checked:i,children:t,defaultChecked:s,disabled:l,form:o,name:c,onCheckedChange:d,required:u,value:p="on",internal_do_not_use_render:h}=e,[v,f]=(0,r.i)({prop:i,defaultProp:null!=s&&s,onChange:d,caller:x}),[g,b]=n.useState(null),[y,C]=n.useState(null),N=n.useRef(!1),I=!g||!!o||!!g.closest("form"),F={checked:v,disabled:l,setChecked:f,control:g,setControl:b,name:c,form:o,value:p,hasConsumerStoppedPropagationRef:N,required:u,defaultChecked:!w(s)&&s,isFormControl:I,bubbleInput:y,setBubbleInput:C};return(0,m.jsx)(j,{scope:a,...F,children:"function"==typeof h?h(F):t})}var g="CheckboxTrigger",b=n.forwardRef((e,a)=>{let{__scopeCheckbox:i,onKeyDown:s,onClick:r,...o}=e,{control:c,value:d,disabled:x,checked:p,required:h,setControl:j,setChecked:f,hasConsumerStoppedPropagationRef:b,isFormControl:y,bubbleInput:C}=v(g,i),N=(0,t.s)(a,j),I=n.useRef(p);return n.useEffect(()=>{let e=null==c?void 0:c.form;if(e){let a=()=>f(I.current);return e.addEventListener("reset",a),()=>e.removeEventListener("reset",a)}},[c,f]),(0,m.jsx)(u.sG.button,{type:"button",role:"checkbox","aria-checked":w(p)?"mixed":p,"aria-required":h,"data-state":R(p),"data-disabled":x?"":void 0,disabled:x,value:d,...o,ref:N,onKeyDown:(0,l.m)(s,e=>{"Enter"===e.key&&e.preventDefault()}),onClick:(0,l.m)(r,e=>{f(e=>!!w(e)||!e),C&&y&&(b.current=e.isPropagationStopped(),b.current||e.stopPropagation())})})});b.displayName=g;var y=n.forwardRef((e,a)=>{let{__scopeCheckbox:i,name:n,checked:t,defaultChecked:s,required:l,disabled:r,value:o,onCheckedChange:c,form:d,...u}=e;return(0,m.jsx)(f,{__scopeCheckbox:i,checked:t,defaultChecked:s,disabled:r,required:l,onCheckedChange:c,name:n,form:d,value:o,internal_do_not_use_render:e=>{let{isFormControl:n}=e;return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)(b,{...u,ref:a,__scopeCheckbox:i}),n&&(0,m.jsx)(F,{__scopeCheckbox:i})]})}})});y.displayName=x;var C="CheckboxIndicator",N=n.forwardRef((e,a)=>{let{__scopeCheckbox:i,forceMount:n,...t}=e,s=v(C,i);return(0,m.jsx)(d.C,{present:n||w(s.checked)||!0===s.checked,children:(0,m.jsx)(u.sG.span,{"data-state":R(s.checked),"data-disabled":s.disabled?"":void 0,...t,ref:a,style:{pointerEvents:"none",...e.style}})})});N.displayName=C;var I="CheckboxBubbleInput",F=n.forwardRef((e,a)=>{let{__scopeCheckbox:i,...s}=e,{control:l,hasConsumerStoppedPropagationRef:r,checked:d,defaultChecked:x,required:p,disabled:h,name:j,value:f,form:g,bubbleInput:b,setBubbleInput:y}=v(I,i),C=(0,t.s)(a,y),N=(0,o.Z)(d),F=(0,c.X)(l);n.useEffect(()=>{if(!b)return;let e=Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype,"checked").set,a=!r.current;if(N!==d&&e){let i=new Event("click",{bubbles:a});b.indeterminate=w(d),e.call(b,!w(d)&&d),b.dispatchEvent(i)}},[b,N,d,r]);let R=n.useRef(!w(d)&&d);return(0,m.jsx)(u.sG.input,{type:"checkbox","aria-hidden":!0,defaultChecked:null!=x?x:R.current,required:p,disabled:h,name:j,value:f,form:g,...s,tabIndex:-1,ref:C,style:{...s.style,...F,position:"absolute",pointerEvents:"none",opacity:0,margin:0,transform:"translateX(-100%)"}})});function w(e){return"indeterminate"===e}function R(e){return w(e)?"indeterminate":e?"checked":"unchecked"}F.displayName=I},77223:(e,a,i)=>{"use strict";i.d(a,{A:()=>n});let n=(0,i(40157).A)("Trash2",[["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6",key:"4alrt4"}],["path",{d:"M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2",key:"v07s0e"}],["line",{x1:"10",x2:"10",y1:"11",y2:"17",key:"1uufr5"}],["line",{x1:"14",x2:"14",y1:"11",y2:"17",key:"xtxkd"}]])},82083:(e,a,i)=>{"use strict";i.d(a,{n:()=>t});var n=i(35476);function t(e,a){return+(0,n.a)(e)==+(0,n.a)(a)}},91467:(e,a,i)=>{"use strict";i.d(a,{A:()=>n});let n=(0,i(40157).A)("Award",[["path",{d:"m15.477 12.89 1.515 8.526a.5.5 0 0 1-.81.47l-3.58-2.687a1 1 0 0 0-1.197 0l-3.586 2.686a.5.5 0 0 1-.81-.469l1.514-8.526",key:"1yiouv"}],["circle",{cx:"12",cy:"8",r:"6",key:"1vp47v"}]])}},e=>{var a=a=>e(e.s=a);e.O(0,[2992,7138,5769,8884,1915,1490,587,7328,8965,1859,6060,6723,3229,6315,1549,8441,1684,7358],()=>a(46908)),_N_E=e.O()}]);